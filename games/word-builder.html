<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Builder üî§</title>
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles for Word Builder */
        body {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .picture-box {
            background: white;
            width: 150px;
            height: 150px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .word-slots {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .slot {
            width: 50px;
            height: 60px;
            background: rgba(255,255,255,0.3);
            border: 3px dashed rgba(255,255,255,0.6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        .slot.filled {
            background: rgba(255,255,255,0.9);
            border: 3px solid #00b894;
            color: #2d3436;
        }
        
        .slot.correct {
            background: #00b894;
            border-color: #00b894;
            color: white;
            animation: correctPop 0.3s ease;
        }
        
        .slot.wrong {
            background: #d63031;
            border-color: #d63031;
            animation: shake 0.3s ease;
        }
        
        @keyframes correctPop {
            50% { transform: scale(1.1); }
        }
        
        .letter-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 350px;
            margin-bottom: 15px;
        }
        
        .letter {
            width: 50px;
            height: 55px;
            background: linear-gradient(145deg, #fdcb6e, #f39c12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        
        .letter:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .letter:active {
            transform: scale(0.95);
        }
        
        .letter.used {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .controls .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            min-width: 110px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .btn-clear {
            background: linear-gradient(145deg, #636e72, #4a5568);
            color: white;
        }
        
        .btn-check {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: white;
        }
        
        .controls .btn:active {
            transform: scale(0.95);
        }
        
        .btn-start {
            margin-top: 15px;
            padding: 15px 35px;
            font-size: 18px;
            background: linear-gradient(145deg, #6c5ce7, #a29bfe);
        }
        
        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.98);
            color: #2d3436;
            padding: 30px 40px;
            border-radius: 25px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        #gameOver h2 { color: #6c5ce7; margin-bottom: 15px; }
        #gameOver p { margin: 8px 0; font-size: 18px; }
        
        .hint-text {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .success-msg {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            animation: successPop 0.8s ease forwards;
            pointer-events: none;
        }
        
        @keyframes successPop {
            0% { opacity: 0; transform: translateX(-50%) scale(0); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-50px) scale(1); }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../index.html" class="home-btn">‚Üê Home</a>
        <a href="category-reading.html" class="category-btn">üìö Reading</a>
        <h1>üî§ Word Builder</h1>
    </div>
    
    <div class="stats">
        <div>Score: <span id="score">0</span></div>
        <div>Level: <span id="level">1</span></div>
        <div>‚≠ê <span id="stars">0</span></div>
    </div>
    
    <div class="picture-box" id="picture">üê±</div>
    
    <div class="word-slots" id="slots"></div>
    
    <div class="letter-bank" id="letterBank"></div>
    
    <div class="controls">
        <button class="btn btn-clear" id="clearBtn">Clear</button>
        <button class="btn btn-check" id="checkBtn">Check ‚úì</button>
    </div>
    
    <p class="hint-text">Tap letters to spell the word!</p>
    
    <div id="gameOver">
        <h2>üéâ Amazing!</h2>
        <p id="playerDisplay"></p>
        <p>Final Score: <span id="finalScore">0</span></p>
        <p>üèÜ High Score: <span id="highScore">0</span></p>
        <p>Words Spelled: <span id="wordsCount">0</span></p>
        <p>Stars Earned: <span id="finalStars">0</span>‚≠ê</p>
        <button class="btn btn-start" onclick="startGame()">Play Again</button>
        <a href="../index.html" class="home-link">‚Üê Back to Home</a>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const words = [
            // Level 1: 3-letter words
            { word: 'cat', emoji: 'üê±' },
            { word: 'dog', emoji: 'üêï' },
            { word: 'sun', emoji: '‚òÄÔ∏è' },
            { word: 'hat', emoji: 'üé©' },
            { word: 'cup', emoji: 'ü•§' },
            { word: 'bed', emoji: 'üõèÔ∏è' },
            { word: 'bus', emoji: 'üöå' },
            { word: 'car', emoji: 'üöó' },
            { word: 'egg', emoji: 'ü•ö' },
            { word: 'ant', emoji: 'üêú' },
            // Level 2: 4-letter words
            { word: 'fish', emoji: 'üêü' },
            { word: 'bird', emoji: 'üê¶' },
            { word: 'tree', emoji: 'üå≥' },
            { word: 'cake', emoji: 'üéÇ' },
            { word: 'book', emoji: 'üìñ' },
            { word: 'star', emoji: '‚≠ê' },
            { word: 'moon', emoji: 'üåô' },
            { word: 'frog', emoji: 'üê∏' },
            { word: 'duck', emoji: 'ü¶Ü' },
            { word: 'lion', emoji: 'ü¶Å' },
            // Level 3: 5-letter words
            { word: 'apple', emoji: 'üçé' },
            { word: 'house', emoji: 'üè†' },
            { word: 'train', emoji: 'üöÇ' },
            { word: 'horse', emoji: 'üê¥' },
            { word: 'pizza', emoji: 'üçï' },
            { word: 'mouse', emoji: 'üê≠' },
            { word: 'plant', emoji: 'üå±' },
            { word: 'beach', emoji: 'üèñÔ∏è' },
            { word: 'robot', emoji: 'ü§ñ' },
            { word: 'heart', emoji: '‚ù§Ô∏è' },
        ];
        
        let score = 0;
        let level = 1;
        let stars = 0;
        let wordsCompleted = 0;
        let currentWord = null;
        let currentGuess = [];
        let gameRunning = false;
        let usedWords = [];
        
        // Use GameUtils for player data and high scores
        const GAME_KEY = 'wordBuilder';
        let highScore = GameUtils.getHighScore(GAME_KEY);
        let playerName = GameUtils.getPlayerName();
        let gradeLevel = GameUtils.getGradeLevel();
        
        const pictureEl = document.getElementById('picture');
        const slotsEl = document.getElementById('slots');
        const letterBankEl = document.getElementById('letterBank');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const starsEl = document.getElementById('stars');
        const gameOverEl = document.getElementById('gameOver');
        
        function getWordsByLevel(lvl) {
            // Adjust available word lengths based on grade
            if (gradeLevel === 'kg') {
                // KG: Only 3-letter words
                return words.filter(w => w.word.length === 3);
            } else if (gradeLevel === 'g1-3') {
                // Grade 1-3: 3 and 4 letter words
                if (lvl <= 3) return words.filter(w => w.word.length === 3);
                return words.filter(w => w.word.length === 4);
            } else {
                // Grade 3-6: All words, progress faster
                if (lvl <= 2) return words.filter(w => w.word.length === 3);
                if (lvl <= 4) return words.filter(w => w.word.length === 4);
                return words.filter(w => w.word.length === 5);
            }
        }
        
        function loadNewWord() {
            const available = getWordsByLevel(level).filter(w => !usedWords.includes(w.word));
            
            if (available.length === 0) {
                // Reset used words for this level
                usedWords = usedWords.filter(w => !getWordsByLevel(level).map(x => x.word).includes(w));
            }
            
            const pool = available.length > 0 ? available : getWordsByLevel(level);
            currentWord = pool[Math.floor(Math.random() * pool.length)];
            usedWords.push(currentWord.word);
            currentGuess = [];
            
            // Show picture
            pictureEl.textContent = currentWord.emoji;
            
            // Create slots
            slotsEl.innerHTML = '';
            for (let i = 0; i < currentWord.word.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                slot.onclick = () => removeLetterAt(i);
                slotsEl.appendChild(slot);
            }
            
            // Create letter bank (word letters + extra random letters)
            const letters = currentWord.word.split('');
            const extraCount = Math.min(4, 8 - letters.length);
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            
            for (let i = 0; i < extraCount; i++) {
                let randomLetter;
                do {
                    randomLetter = alphabet[Math.floor(Math.random() * 26)];
                } while (letters.filter(l => l === randomLetter).length >= 2);
                letters.push(randomLetter);
            }
            
            // Shuffle
            letters.sort(() => Math.random() - 0.5);
            
            letterBankEl.innerHTML = '';
            letters.forEach((letter, i) => {
                const letterEl = document.createElement('div');
                letterEl.className = 'letter';
                letterEl.textContent = letter;
                letterEl.dataset.index = i;
                letterEl.onclick = () => addLetter(letter, i);
                letterBankEl.appendChild(letterEl);
            });
        }
        
        function addLetter(letter, bankIndex) {
            if (currentGuess.length >= currentWord.word.length) return;
            
            currentGuess.push({ letter, bankIndex });
            updateSlots();
            
            // Mark letter as used
            const letterEls = letterBankEl.querySelectorAll('.letter');
            letterEls[bankIndex].classList.add('used');
            
            // Play click sound
            GameUtils.playSound('click');
        }
        
        function removeLetterAt(slotIndex) {
            if (slotIndex >= currentGuess.length) return;
            
            const removed = currentGuess.splice(slotIndex, 1)[0];
            
            // Unmark letter in bank
            const letterEls = letterBankEl.querySelectorAll('.letter');
            letterEls[removed.bankIndex].classList.remove('used');
            
            updateSlots();
        }
        
        function updateSlots() {
            const slots = slotsEl.querySelectorAll('.slot');
            slots.forEach((slot, i) => {
                if (i < currentGuess.length) {
                    slot.textContent = currentGuess[i].letter;
                    slot.classList.add('filled');
                } else {
                    slot.textContent = '';
                    slot.classList.remove('filled');
                }
                slot.classList.remove('correct', 'wrong');
            });
        }
        
        function clearWord() {
            currentGuess.forEach(g => {
                const letterEls = letterBankEl.querySelectorAll('.letter');
                letterEls[g.bankIndex].classList.remove('used');
            });
            currentGuess = [];
            updateSlots();
        }
        
        function checkWord() {
            if (!gameRunning || currentGuess.length !== currentWord.word.length) return;
            
            const guess = currentGuess.map(g => g.letter).join('');
            const slots = slotsEl.querySelectorAll('.slot');
            
            if (guess === currentWord.word) {
                // Correct!
                slots.forEach(slot => slot.classList.add('correct'));
                score += currentWord.word.length * 10;
                wordsCompleted++;
                stars++;
                
                scoreEl.textContent = score;
                starsEl.textContent = stars;
                
                // Play correct sound
                GameUtils.playSound('correct');
                
                showSuccess();
                
                // Level up every 3 words
                if (wordsCompleted % 3 === 0 && level < 6) {
                    level++;
                    levelEl.textContent = level;
                    GameUtils.playSound('levelUp');
                }
                
                setTimeout(() => {
                    if (wordsCompleted >= 10) {
                        endGame();
                    } else {
                        loadNewWord();
                    }
                }, 800);
            } else {
                // Wrong
                slots.forEach(slot => slot.classList.add('wrong'));
                GameUtils.playSound('wrong');
                setTimeout(() => {
                    slots.forEach(slot => slot.classList.remove('wrong'));
                }, 400);
            }
        }
        
        function showSuccess() {
            const msg = document.createElement('div');
            msg.className = 'success-msg';
            msg.textContent = '‚≠ê Great! ‚≠ê';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 800);
        }
        
        function startGame() {
            score = 0;
            level = 1;
            stars = 0;
            wordsCompleted = 0;
            usedWords = [];
            gameRunning = true;
            
            // Refresh player data in case it changed
            playerName = GameUtils.getPlayerName();
            gradeLevel = GameUtils.getGradeLevel();
            highScore = GameUtils.getHighScore(GAME_KEY);
            
            scoreEl.textContent = '0';
            levelEl.textContent = '1';
            starsEl.textContent = '0';
            gameOverEl.style.display = 'none';
            
            loadNewWord();
        }
        
        function endGame() {
            gameRunning = false;
            
            // Save high score using GameUtils
            const isNewHighScore = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            if (isNewHighScore) {
                highScore = score;
            }
            
            const bestScore = Math.max(score, highScore);
            const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('highScore').textContent = `${bestScore} by ${bestPlayer}`;
            document.getElementById('wordsCount').textContent = wordsCompleted;
            document.getElementById('finalStars').textContent = stars;
            document.getElementById('playerDisplay').textContent = playerName + "'s Game";
            gameOverEl.style.display = 'block';
        }
        
        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            if (e.key === 'Backspace') {
                if (currentGuess.length > 0) {
                    removeLetterAt(currentGuess.length - 1);
                }
            } else if (e.key === 'Enter') {
                checkWord();
            } else if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                // Find unused letter in bank
                const letterEls = letterBankEl.querySelectorAll('.letter');
                for (let i = 0; i < letterEls.length; i++) {
                    if (!letterEls[i].classList.contains('used') && 
                        letterEls[i].textContent.toLowerCase() === e.key.toLowerCase()) {
                        addLetter(e.key.toLowerCase(), i);
                        break;
                    }
                }
            }
        });

        // Button event listeners with touch support
        const clearBtn = document.getElementById('clearBtn');
        const checkBtn = document.getElementById('checkBtn');
        
        // Clear button
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearWord();
        });
        clearBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearWord();
        }, { passive: false });
        
        // Check button
        checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            checkWord();
        });
        checkBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            checkWord();
        }, { passive: false });

        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
</body>
</html>
