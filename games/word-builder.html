<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Word Builder üî§</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles for Word Builder */
        body {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .picture-box {
            background: white;
            width: 150px;
            height: 150px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .word-slots {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .slot {
            width: 50px;
            height: 60px;
            background: rgba(255,255,255,0.3);
            border: 3px dashed rgba(255,255,255,0.6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        .slot.filled {
            background: rgba(255,255,255,0.9);
            border: 3px solid #00b894;
            color: #2d3436;
        }
        
        .slot.correct {
            background: #00b894;
            border-color: #00b894;
            color: white;
            animation: correctPop 0.3s ease;
        }
        
        .slot.wrong {
            background: #d63031;
            border-color: #d63031;
            animation: shake 0.3s ease;
        }
        
        @keyframes correctPop {
            50% { transform: scale(1.1); }
        }
        
        .letter-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 350px;
            margin-bottom: 15px;
        }
        
        .letter {
            width: 50px;
            height: 55px;
            background: linear-gradient(145deg, #fdcb6e, #f39c12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        
        .letter:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .letter:active {
            transform: scale(0.95);
        }
        
        .letter.used {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .controls .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            min-width: 110px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .btn-clear {
            background: linear-gradient(145deg, #636e72, #4a5568);
            color: white;
        }
        
        .btn-check {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: white;
        }
        
        .controls .btn:active {
            transform: scale(0.95);
        }
        
        .btn-start {
            margin-top: 15px;
            padding: 15px 35px;
            font-size: 18px;
            background: linear-gradient(145deg, #6c5ce7, #a29bfe);
        }
        
#gameOver h2 { color: #6c5ce7; }
        
        .hint-text {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .success-msg {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            animation: successPop 0.8s ease forwards;
            pointer-events: none;
        }
        
        @keyframes successPop {
            0% { opacity: 0; transform: translateX(-50%) scale(0); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-50px) scale(1); }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../home.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-reading.html" class="category-btn" data-i18n="nav.reading">üìö Reading</a>
        <h1 data-i18n="wordBuilder.title">üî§ Word Builder</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
        <div>üìù <span id="progress">1</span>/15</div>
        <div>‚ù§Ô∏è <span id="lives">3</span></div>
    </div>
    
    <div class="picture-box" id="picture">üê±</div>
    
    <div class="word-slots" id="slots"></div>
    
    <div class="letter-bank" id="letterBank"></div>
    
    <div class="controls">
        <button class="btn btn-clear" id="clearBtn" data-i18n="wordBuilder.clear">Clear</button>
        <button class="btn btn-check" id="checkBtn" data-i18n="wordBuilder.check">Check ‚úì</button>
    </div>
    
    <p class="hint-text" data-i18n="wordBuilder.hint">Tap letters to spell the word! Spell 15 words to win!</p>
    <p class="hint-text" id="bestScoreDisplay">üèÜ Best: --</p>
    
    <div id="gameOver" class="light-theme">
        <h2 id="resultTitle">üéâ Amazing!</h2>
        <p id="playerDisplay"></p>
        <p><span data-i18n="game.finalScoreLabel">Final Score</span>: <span id="finalScore">0</span></p>
        <p>üèÜ <span data-i18n="game.best">High Score</span>: <span id="highScore">0</span></p>
        <p><span data-i18n="wordBuilder.wordsSpelled">Words Spelled</span>: <span id="wordsCount">0</span>/15</p>
        <button class="btn btn-start" onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
        <a href="../home.html" class="home-link" data-i18n="btn.back">‚Üê Back to Home</a>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        // English words - 100 words
        const wordsEn = [
            // Level 1: 3-letter words (35 words)
            { word: 'cat', emoji: 'üê±' },
            { word: 'dog', emoji: 'üêï' },
            { word: 'sun', emoji: '‚òÄÔ∏è' },
            { word: 'hat', emoji: 'üé©' },
            { word: 'cup', emoji: 'ü•§' },
            { word: 'bed', emoji: 'üõèÔ∏è' },
            { word: 'bus', emoji: 'üöå' },
            { word: 'car', emoji: 'üöó' },
            { word: 'egg', emoji: 'ü•ö' },
            { word: 'ant', emoji: 'üêú' },
            { word: 'bee', emoji: 'üêù' },
            { word: 'cow', emoji: 'üêÑ' },
            { word: 'pig', emoji: 'üê∑' },
            { word: 'owl', emoji: 'ü¶â' },
            { word: 'bat', emoji: 'ü¶á' },
            { word: 'fox', emoji: 'ü¶ä' },
            { word: 'box', emoji: 'üì¶' },
            { word: 'key', emoji: 'üîë' },
            { word: 'pen', emoji: 'üñäÔ∏è' },
            { word: 'eye', emoji: 'üëÅÔ∏è' },
            { word: 'ear', emoji: 'üëÇ' },
            { word: 'leg', emoji: 'ü¶µ' },
            { word: 'ice', emoji: 'üßä' },
            { word: 'pie', emoji: 'ü•ß' },
            { word: 'jar', emoji: 'ü´ô' },
            { word: 'nut', emoji: 'ü•ú' },
            { word: 'boy', emoji: 'üë¶' },
            { word: 'mom', emoji: 'üë©' },
            { word: 'dad', emoji: 'üë®' },
            { word: 'toy', emoji: 'üß∏' },
            { word: 'bug', emoji: 'üêû' },
            { word: 'hen', emoji: 'üêî' },
            { word: 'map', emoji: 'üó∫Ô∏è' },
            { word: 'net', emoji: 'ü•Ö' },
            { word: 'pot', emoji: 'üç≤' },
            // Level 2: 4-letter words (35 words)
            { word: 'fish', emoji: 'üêü' },
            { word: 'bird', emoji: 'üê¶' },
            { word: 'tree', emoji: 'üå≥' },
            { word: 'cake', emoji: 'üéÇ' },
            { word: 'book', emoji: 'üìñ' },
            { word: 'star', emoji: '‚≠ê' },
            { word: 'moon', emoji: 'üåô' },
            { word: 'frog', emoji: 'üê∏' },
            { word: 'duck', emoji: 'ü¶Ü' },
            { word: 'lion', emoji: 'ü¶Å' },
            { word: 'bear', emoji: 'üêª' },
            { word: 'deer', emoji: 'ü¶å' },
            { word: 'goat', emoji: 'üêê' },
            { word: 'lamb', emoji: 'üêë' },
            { word: 'crab', emoji: 'ü¶Ä' },
            { word: 'snail', emoji: 'üêå' },
            { word: 'ball', emoji: '‚öΩ' },
            { word: 'bell', emoji: 'üîî' },
            { word: 'gift', emoji: 'üéÅ' },
            { word: 'kite', emoji: 'ü™Å' },
            { word: 'boat', emoji: '‚õµ' },
            { word: 'ship', emoji: 'üö¢' },
            { word: 'bike', emoji: 'üö≤' },
            { word: 'door', emoji: 'üö™' },
            { word: 'lamp', emoji: 'üí°' },
            { word: 'milk', emoji: 'ü•õ' },
            { word: 'corn', emoji: 'üåΩ' },
            { word: 'pear', emoji: 'üçê' },
            { word: 'sock', emoji: 'üß¶' },
            { word: 'rain', emoji: 'üåßÔ∏è' },
            { word: 'snow', emoji: '‚ùÑÔ∏è' },
            { word: 'fire', emoji: 'üî•' },
            { word: 'leaf', emoji: 'üçÉ' },
            { word: 'rose', emoji: 'üåπ' },
            { word: 'hand', emoji: '‚úã' },
            // Level 3: 5+ letter words (30 words)
            { word: 'apple', emoji: 'üçé' },
            { word: 'house', emoji: 'üè†' },
            { word: 'train', emoji: 'üöÇ' },
            { word: 'horse', emoji: 'üê¥' },
            { word: 'pizza', emoji: 'üçï' },
            { word: 'mouse', emoji: 'üê≠' },
            { word: 'plant', emoji: 'üå±' },
            { word: 'beach', emoji: 'üèñÔ∏è' },
            { word: 'robot', emoji: 'ü§ñ' },
            { word: 'heart', emoji: '‚ù§Ô∏è' },
            { word: 'tiger', emoji: 'üêØ' },
            { word: 'zebra', emoji: 'ü¶ì' },
            { word: 'whale', emoji: 'üêã' },
            { word: 'shark', emoji: 'ü¶à' },
            { word: 'snake', emoji: 'üêç' },
            { word: 'turtle', emoji: 'üê¢' },
            { word: 'rabbit', emoji: 'üê∞' },
            { word: 'monkey', emoji: 'üêµ' },
            { word: 'giraffe', emoji: 'ü¶í' },
            { word: 'dolphin', emoji: 'üê¨' },
            { word: 'orange', emoji: 'üçä' },
            { word: 'banana', emoji: 'üçå' },
            { word: 'grapes', emoji: 'üçá' },
            { word: 'carrot', emoji: 'ü•ï' },
            { word: 'tomato', emoji: 'üçÖ' },
            { word: 'cheese', emoji: 'üßÄ' },
            { word: 'bread', emoji: 'üçû' },
            { word: 'phone', emoji: 'üì±' },
            { word: 'camera', emoji: 'üì∑' },
            { word: 'school', emoji: 'üè´' },
            { word: 'clock', emoji: '‚è∞' },
        ];
        
        // Arabic words (ŸÉŸÑŸÖÿßÿ™ ÿπÿ±ÿ®Ÿäÿ©) - 100 ŸÉŸÑŸÖÿ©
        const wordsAr = [
            // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ Ÿ°: ŸÉŸÑŸÖÿßÿ™ ŸÖŸÜ Ÿ£ ÿ≠ÿ±ŸàŸÅ (35 ŸÉŸÑŸÖÿ©)
            { word: 'ŸÇÿ∑ÿ©', emoji: 'üê±' },
            { word: 'ŸÉŸÑÿ®', emoji: 'üêï' },
            { word: 'ÿ¥ŸÖÿ≥', emoji: '‚òÄÔ∏è' },
            { word: 'ÿ®ÿßÿ®', emoji: 'üö™' },
            { word: 'ŸÇŸÖÿ±', emoji: 'üåô' },
            { word: 'ÿ®Ÿäÿ™', emoji: 'üè†' },
            { word: 'ŸÜÿ¨ŸÖ', emoji: '‚≠ê' },
            { word: 'ŸÖÿßÿ°', emoji: 'üíß' },
            { word: 'ŸàŸÑÿØ', emoji: 'üë¶' },
            { word: 'ÿ®ŸÜÿ™', emoji: 'üëß' },
            { word: 'ÿ£ŸÖ', emoji: 'üë©' },
            { word: 'ÿ£ÿ®', emoji: 'üë®' },
            { word: 'ŸäÿØ', emoji: '‚úã' },
            { word: 'ÿπŸäŸÜ', emoji: 'üëÅÔ∏è' },
            { word: 'ÿ£ŸÜŸÅ', emoji: 'üëÉ' },
            { word: 'ŸÅŸÖ', emoji: 'üëÑ' },
            { word: 'ÿ£ÿ∞ŸÜ', emoji: 'üëÇ' },
            { word: 'ŸÇÿØŸÖ', emoji: 'ü¶∂' },
            { word: 'ÿÆÿ®ÿ≤', emoji: 'üçû' },
            { word: 'ÿ¨ÿ®ŸÜ', emoji: 'üßÄ' },
            { word: 'ÿ®Ÿäÿ∂', emoji: 'ü•ö' },
            { word: 'ÿ≠ÿ®', emoji: '‚ù§Ô∏è' },
            { word: 'ŸÜÿßÿ±', emoji: 'üî•' },
            { word: 'ÿ´ŸÑÿ¨', emoji: '‚ùÑÔ∏è' },
            { word: 'ŸÖÿ∑ÿ±', emoji: 'üåßÔ∏è' },
            { word: 'ÿ®ÿ±ŸÇ', emoji: '‚ö°' },
            { word: 'ÿ®ÿ≠ÿ±', emoji: 'üåä' },
            { word: 'ÿ¨ÿ®ŸÑ', emoji: '‚õ∞Ô∏è' },
            { word: 'ŸÜŸáÿ±', emoji: 'üèûÔ∏è' },
            { word: 'ÿØÿ®ÿØŸàÿ®', emoji: 'üß∏' },
            { word: 'ŸÇÿ®ÿπÿ©', emoji: 'üß¢' },
            { word: 'ÿ¨ÿØ', emoji: 'üë¥' },
            { word: 'ÿ¨ÿØÿ©', emoji: 'üëµ' },
            { word: 'ÿ∑ŸÅŸÑ', emoji: 'üë∂' },
            { word: 'ŸÉÿ±ÿ©', emoji: '‚öΩ' },
            // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ Ÿ¢: ŸÉŸÑŸÖÿßÿ™ ŸÖŸÜ Ÿ§ ÿ≠ÿ±ŸàŸÅ (35 ŸÉŸÑŸÖÿ©)
            { word: 'ÿ≥ŸÖŸÉÿ©', emoji: 'üêü' },
            { word: 'Ÿàÿ±ÿØÿ©', emoji: 'üåπ' },
            { word: 'ÿ™ŸÅÿßÿ≠ÿ©', emoji: 'üçé' },
            { word: 'ŸÖŸàÿ≤ÿ©', emoji: 'üçå' },
            { word: 'ŸÉÿ™ÿßÿ®', emoji: 'üìñ' },
            { word: 'ŸÇŸÑÿπÿ©', emoji: 'üè∞' },
            { word: 'ÿ∑ÿßÿ¶ÿ±', emoji: 'üê¶' },
            { word: 'ÿ¥ÿ¨ÿ±ÿ©', emoji: 'üå≥' },
            { word: 'ÿ≤Ÿáÿ±ÿ©', emoji: 'üå∏' },
            { word: 'ÿ®ÿ∑ÿ©', emoji: 'ü¶Ü' },
            { word: 'ÿ£ÿ≥ÿØ', emoji: 'ü¶Å' },
            { word: 'ŸÅŸäŸÑ', emoji: 'üêò' },
            { word: 'ŸÜŸÖÿ±', emoji: 'üêØ' },
            { word: 'ÿØÿ®', emoji: 'üêª' },
            { word: 'ÿ£ÿ±ŸÜÿ®', emoji: 'üê∞' },
            { word: 'ŸÇÿ±ÿØ', emoji: 'üêµ' },
            { word: 'ÿ´ÿπŸÑÿ®', emoji: 'ü¶ä' },
            { word: 'ÿ®ŸÇÿ±ÿ©', emoji: 'üêÑ' },
            { word: 'ÿÆÿ±ŸàŸÅ', emoji: 'üêë' },
            { word: 'ÿØÿ¨ÿßÿ¨ÿ©', emoji: 'üêî' },
            { word: 'ÿØŸäŸÉ', emoji: 'üêì' },
            { word: 'ÿ≠ŸÖÿßŸÖÿ©', emoji: 'üïäÔ∏è' },
            { word: 'ŸÜÿ≠ŸÑÿ©', emoji: 'üêù' },
            { word: 'ÿπŸÜÿ®', emoji: 'üçá' },
            { word: 'ÿ®ÿ±ÿ™ŸÇÿßŸÑÿ©', emoji: 'üçä' },
            { word: 'ŸÑŸäŸÖŸàŸÜ', emoji: 'üçã' },
            { word: 'ŸÅÿ±ÿßŸàŸÑÿ©', emoji: 'üçì' },
            { word: 'ÿ®ÿ∑ŸäÿÆ', emoji: 'üçâ' },
            { word: 'ÿ¨ÿ≤ÿ±ÿ©', emoji: 'ü•ï' },
            { word: 'ÿ∑ŸÖÿßÿ∑ŸÖ', emoji: 'üçÖ' },
            { word: 'ÿÆŸäÿßÿ±', emoji: 'ü•í' },
            { word: 'ÿ®ÿ∑ÿßÿ∑ÿß', emoji: 'ü•î' },
            { word: 'ÿ∞ÿ±ÿ©', emoji: 'üåΩ' },
            { word: 'ŸÇŸÑŸÖ', emoji: '‚úèÔ∏è' },
            // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ Ÿ£: ŸÉŸÑŸÖÿßÿ™ ŸÖŸÜ Ÿ•+ ÿ≠ÿ±ŸàŸÅ (30 ŸÉŸÑŸÖÿ©)
            { word: 'ÿ≥Ÿäÿßÿ±ÿ©', emoji: 'üöó' },
            { word: 'ŸÅÿ±ÿßÿ¥ÿ©', emoji: 'ü¶ã' },
            { word: 'ÿ∑ÿßÿ¶ÿ±ÿ©', emoji: '‚úàÔ∏è' },
            { word: 'ŸÖÿØÿ±ÿ≥ÿ©', emoji: 'üè´' },
            { word: 'ÿ≠ÿØŸäŸÇÿ©', emoji: 'üå∑' },
            { word: 'ÿØÿ±ÿßÿ¨ÿ©', emoji: 'üö≤' },
            { word: 'ÿπÿµŸÅŸàÿ±', emoji: 'üê§' },
            { word: 'ÿ≥ÿßÿπÿ©', emoji: '‚è∞' },
            { word: 'ŸÉÿ±ÿ≥Ÿä', emoji: 'ü™ë' },
            { word: 'ŸÇÿ∑ÿßÿ±', emoji: 'üöÇ' },
            { word: 'ÿ≠ÿµÿßŸÜ', emoji: 'üê¥' },
            { word: 'ÿ≤ÿ±ÿßŸÅÿ©', emoji: 'ü¶í' },
            { word: 'ÿ™ŸÖÿ≥ÿßÿ≠', emoji: 'üêä' },
            { word: 'ÿ≥ŸÑÿ≠ŸÅÿßÿ©', emoji: 'üê¢' },
            { word: 'ÿØŸÑŸÅŸäŸÜ', emoji: 'üê¨' },
            { word: 'ÿ≠Ÿàÿ™', emoji: 'üêã' },
            { word: 'ÿ£ÿÆÿ∑ÿ®Ÿàÿ∑', emoji: 'üêô' },
            { word: 'ÿπŸÜŸÉÿ®Ÿàÿ™', emoji: 'üï∑Ô∏è' },
            { word: 'ÿ≥ÿ≠ÿßÿ®ÿ©', emoji: '‚òÅÔ∏è' },
            { word: 'ŸÜÿßŸÅÿ∞ÿ©', emoji: 'ü™ü' },
            { word: 'ŸÖÿ∏ŸÑÿ©', emoji: '‚òÇÔ∏è' },
            { word: 'Ÿáÿßÿ™ŸÅ', emoji: 'üì±' },
            { word: 'ÿ™ŸÑŸÅÿßÿ≤', emoji: 'üì∫' },
            { word: 'ŸÉÿßŸÖŸäÿ±ÿß', emoji: 'üì∑' },
            { word: 'ÿ≠ÿßÿ≥Ÿàÿ®', emoji: 'üíª' },
            { word: 'ÿ¨ÿ±ÿ≥', emoji: 'üîî' },
            { word: 'ÿ¥ŸÖÿπÿ©', emoji: 'üïØÔ∏è' },
            { word: 'ŸÖÿµÿ®ÿßÿ≠', emoji: 'üí°' },
            { word: 'ŸÖŸÅÿ™ÿßÿ≠', emoji: 'üîë' },
            { word: 'ŸÜÿ∏ÿßÿ±ÿ©', emoji: 'üëì' },
        ];
        
        // Get words based on current language
        function getWords() {
            const lang = typeof I18n !== 'undefined' ? I18n.currentLang : 'en';
            return lang === 'ar' ? wordsAr : wordsEn;
        }
        
        let score = 0;
        let level = 1;
        let lives = 3;
        let wordsCompleted = 0;
        let currentWord = null;
        let currentGuess = [];
        let gameRunning = false;
        let usedWords = [];
        
        // Use GameUtils for player data and high scores
        const GAME_KEY = 'wordBuilder';
        let highScore = GameUtils.getHighScore(GAME_KEY);
        let playerName = GameUtils.getPlayerName();
        let gradeLevel = GameUtils.getGradeLevel();
        
        const pictureEl = document.getElementById('picture');
        const slotsEl = document.getElementById('slots');
        const letterBankEl = document.getElementById('letterBank');
        const scoreEl = document.getElementById('score');
        const progressEl = document.getElementById('progress');
        const livesEl = document.getElementById('lives');
        const gameOverEl = document.getElementById('gameOver');
        
        function getWordsByLevel(lvl) {
            const words = getWords();
            const lang = typeof I18n !== 'undefined' ? I18n.currentLang : 'en';
            
            // For Arabic, use different length thresholds
            const shortLen = lang === 'ar' ? 3 : 3;
            const medLen = lang === 'ar' ? 4 : 4;
            
            // Adjust available word lengths based on grade
            if (gradeLevel === 'kg') {
                // KG: Only short words
                return words.filter(w => w.word.length <= shortLen);
            } else if (gradeLevel === 'g1-3') {
                // Grade 1-3: Short and medium words
                if (lvl <= 3) return words.filter(w => w.word.length <= shortLen);
                return words.filter(w => w.word.length <= medLen);
            } else {
                // Grade 3-6: All words, progress faster
                if (lvl <= 2) return words.filter(w => w.word.length <= shortLen);
                if (lvl <= 4) return words.filter(w => w.word.length <= medLen);
                return words;
            }
        }
        
        function loadNewWord() {
            const available = getWordsByLevel(level).filter(w => !usedWords.includes(w.word));
            
            if (available.length === 0) {
                // Reset used words for this level
                usedWords = usedWords.filter(w => !getWordsByLevel(level).map(x => x.word).includes(w));
            }
            
            const pool = available.length > 0 ? available : getWordsByLevel(level);
            // Shuffle pool using Fisher-Yates algorithm for true randomness
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            currentWord = pool[0];
            usedWords.push(currentWord.word);
            currentGuess = [];
            
            // Show picture
            pictureEl.textContent = currentWord.emoji;
            
            // Create slots
            slotsEl.innerHTML = '';
            for (let i = 0; i < currentWord.word.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                slot.onclick = () => removeLetterAt(i);
                slotsEl.appendChild(slot);
            }
            
            // Create letter bank (word letters + extra random letters)
            const letters = currentWord.word.split('');
            const extraCount = Math.min(4, 8 - letters.length);
            const lang = typeof I18n !== 'undefined' ? I18n.currentLang : 'en';
            const alphabet = lang === 'ar' 
                ? 'ÿ£ÿ®ÿ™ÿ´ÿ¨ÿ≠ÿÆÿØÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ÿπÿ∫ŸÅŸÇŸÉŸÑŸÖŸÜŸáŸàŸä'
                : 'abcdefghijklmnopqrstuvwxyz';
            
            for (let i = 0; i < extraCount; i++) {
                let randomLetter;
                do {
                    randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                } while (letters.filter(l => l === randomLetter).length >= 2);
                letters.push(randomLetter);
            }
            
            // Shuffle
            letters.sort(() => Math.random() - 0.5);
            
            letterBankEl.innerHTML = '';
            letters.forEach((letter, i) => {
                const letterEl = document.createElement('div');
                letterEl.className = 'letter';
                letterEl.textContent = letter;
                letterEl.dataset.index = i;
                letterEl.onclick = () => addLetter(letter, i);
                letterBankEl.appendChild(letterEl);
            });
        }
        
        function addLetter(letter, bankIndex) {
            if (currentGuess.length >= currentWord.word.length) return;
            
            currentGuess.push({ letter, bankIndex });
            updateSlots();
            
            // Mark letter as used
            const letterEls = letterBankEl.querySelectorAll('.letter');
            letterEls[bankIndex].classList.add('used');
            
            // Play click sound
            GameUtils.playSound('click');
        }
        
        function removeLetterAt(slotIndex) {
            if (slotIndex >= currentGuess.length) return;
            
            const removed = currentGuess.splice(slotIndex, 1)[0];
            
            // Unmark letter in bank
            const letterEls = letterBankEl.querySelectorAll('.letter');
            letterEls[removed.bankIndex].classList.remove('used');
            
            updateSlots();
        }
        
        function updateSlots() {
            const slots = slotsEl.querySelectorAll('.slot');
            slots.forEach((slot, i) => {
                if (i < currentGuess.length) {
                    slot.textContent = currentGuess[i].letter;
                    slot.classList.add('filled');
                } else {
                    slot.textContent = '';
                    slot.classList.remove('filled');
                }
                slot.classList.remove('correct', 'wrong');
            });
        }
        
        function clearWord() {
            currentGuess.forEach(g => {
                const letterEls = letterBankEl.querySelectorAll('.letter');
                letterEls[g.bankIndex].classList.remove('used');
            });
            currentGuess = [];
            updateSlots();
        }
        
        function checkWord() {
            if (!gameRunning || currentGuess.length !== currentWord.word.length) return;
            
            const guess = currentGuess.map(g => g.letter).join('');
            const slots = slotsEl.querySelectorAll('.slot');
            
            if (guess === currentWord.word) {
                // Correct!
                slots.forEach(slot => slot.classList.add('correct'));
                score += currentWord.word.length * 10;
                wordsCompleted++;
                
                scoreEl.textContent = score;
                progressEl.textContent = Math.min(wordsCompleted + 1, 15);
                
                // Play correct sound
                GameUtils.playSound('correct');
                
                showSuccess();
                
                // Level up every 3 words
                if (wordsCompleted % 3 === 0 && level < 6) {
                    level++;
                    GameUtils.playSound('levelUp');
                }
                
                setTimeout(() => {
                    if (wordsCompleted >= 15) {
                        endGame(true);
                    } else {
                        loadNewWord();
                    }
                }, 800);
            } else {
                // Wrong
                slots.forEach(slot => slot.classList.add('wrong'));
                lives--;
                livesEl.textContent = lives;
                GameUtils.playSound('wrong');
                
                setTimeout(() => {
                    slots.forEach(slot => slot.classList.remove('wrong'));
                    clearWord();
                    
                    if (lives <= 0) {
                        endGame(false);
                    }
                }, 600);
            }
        }
        
        function showSuccess() {
            const msg = document.createElement('div');
            msg.className = 'success-msg';
            msg.textContent = typeof I18n !== 'undefined' ? I18n.t('wordBuilder.great') : '‚≠ê Great! ‚≠ê';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 800);
        }
        
        function startGame() {
            score = 0;
            level = 1;
            wordsCompleted = 0;
            usedWords = [];
            gameRunning = true;
            
            // Refresh player data in case it changed
            playerName = GameUtils.getPlayerName();
            gradeLevel = GameUtils.getGradeLevel();
            highScore = GameUtils.getHighScore(GAME_KEY);
            
            lives = GameUtils.getMaxLives({kg: 10, 'g1-3': 5, default: 3});
            
            scoreEl.textContent = '0';
            progressEl.textContent = '1';
            livesEl.textContent = lives;
            gameOverEl.style.display = 'none';
            
            loadNewWord();
        }
        
        function loadHighScore() {
            const saved = GameUtils.getHighScore(GAME_KEY);
            if (saved > 0) {
                const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
                const highScoreText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.highScorePoints', { score: saved, player: bestPlayer })
                    : `üèÜ Best: ${saved} points by ${bestPlayer}`;
                document.getElementById('bestScoreDisplay').innerHTML = highScoreText;
            } else {
                const defaultText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.defaultHighScore')
                    : 'Best: -- points';
                document.getElementById('bestScoreDisplay').innerHTML = defaultText;
            }
        }
        
        function endGame(won) {
            gameRunning = false;
            
            // Save high score using GameUtils
            const isNewHighScore = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            if (isNewHighScore) {
                highScore = score;
            }
            
            const bestScore = Math.max(score, highScore);
            const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
            const lang = typeof I18n !== 'undefined' ? I18n.currentLang : 'en';
            
            // Update title based on win/lose with translation
            const titleEl = document.getElementById('resultTitle');
            if (won) {
                titleEl.textContent = lang === 'ar' ? 'üéâ ÿ±ÿßÿ¶ÿπ!' : 'üéâ Amazing!';
            } else {
                titleEl.textContent = lang === 'ar' ? 'üòÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸäÿØÿ©!' : 'üòÖ Good Try!';
            }
            
            document.getElementById('finalScore').textContent = score;
            
            // Format high score with translation
            const byText = lang === 'ar' ? 'ÿ®Ÿàÿßÿ≥ÿ∑ÿ©' : 'by';
            document.getElementById('highScore').textContent = `${bestScore} ${byText} ${bestPlayer}`;
            
            document.getElementById('wordsCount').textContent = wordsCompleted;
            
            // Format player display with translation
            const gameText = lang === 'ar' ? `ŸÑÿπÿ®ÿ© ${playerName}` : `${playerName}'s Game`;
            document.getElementById('playerDisplay').textContent = gameText;
            
            gameOverEl.style.display = 'block';
            loadHighScore();
            
            // Re-translate page elements
            if (typeof I18n !== 'undefined') {
                I18n.translatePage();
            }
        }
        
        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            if (e.key === 'Backspace') {
                if (currentGuess.length > 0) {
                    removeLetterAt(currentGuess.length - 1);
                }
            } else if (e.key === 'Enter') {
                checkWord();
            } else if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                // Find unused letter in bank
                const letterEls = letterBankEl.querySelectorAll('.letter');
                for (let i = 0; i < letterEls.length; i++) {
                    if (!letterEls[i].classList.contains('used') && 
                        letterEls[i].textContent.toLowerCase() === e.key.toLowerCase()) {
                        addLetter(e.key.toLowerCase(), i);
                        break;
                    }
                }
            }
        });

        // Button event listeners with touch support
        const clearBtn = document.getElementById('clearBtn');
        const checkBtn = document.getElementById('checkBtn');
        
        // Clear button
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearWord();
        });
        clearBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearWord();
        }, { passive: false });
        
        // Check button
        checkBtn.addEventListener('click', (e) => {
            e.preventDefault();
            checkWord();
        });
        checkBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            checkWord();
        }, { passive: false });

        // Initialize sound toggle
        GameUtils.initSoundToggle();
        loadHighScore();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
