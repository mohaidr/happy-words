<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Memory Match üß†</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific background */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 340px;
            margin-bottom: 20px;
            padding: 0 5px;
            box-sizing: border-box;
        }
        
        .game-board.cols-5 {
            grid-template-columns: repeat(5, 1fr);
            max-width: 100%;
            width: calc(100vw - 20px);
            max-width: min(400px, calc(100vw - 20px));
            gap: 6px;
        }
        
        .card {
            width: 100%;
            aspect-ratio: 1;
            max-width: 75px;
            max-height: 75px;
            background: linear-gradient(145deg, #5a67d8, #4c51bf);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(22px, 6vw, 35px);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .game-board.cols-5 .card {
            max-width: 65px;
            max-height: 65px;
            border-radius: 8px;
            font-size: clamp(18px, 5vw, 28px);
        }
        
        .card::before {
            content: '?';
            font-size: clamp(20px, 5vw, 30px);
            color: rgba(255,255,255,0.7);
        }
        
        .game-board.cols-5 .card::before {
            font-size: clamp(16px, 4vw, 24px);
        }
        
        .card.flipped::before {
            content: none;
        }
        
        .card.flipped {
            background: white;
            transform: rotateY(180deg);
        }
        
        .card .emoji {
            display: none;
            transform: rotateY(180deg);
        }
        
        .card.flipped .emoji {
            display: block;
        }
        
        .card.matched {
            background: linear-gradient(145deg, #48bb78, #38a169);
            animation: matchPulse 0.5s ease;
            pointer-events: none;
        }
        
        .card.matched .emoji {
            display: block;
            transform: rotateY(180deg);
        }
        
        @keyframes matchPulse {
            0%, 100% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
        }
        
        .message {
            font-size: 20px;
            margin-bottom: 15px;
            min-height: 30px;
            text-align: center;
        }
        
        .start-btn {
            background: linear-gradient(145deg, #f093fb, #f5576c);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(240,147,251,0.4);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(240,147,251,0.6);
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.3);
            border-radius: 10px;
            font-size: 14px;
        }
        
        .level-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .level-btn {
            padding: 10px 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-btn.active {
            background: linear-gradient(145deg, #48bb78, #38a169);
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../index.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-logic.html" class="category-btn" data-i18n="nav.logic">üß† Logic</a>
        <h1>üß† Memory Match</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.moves">Moves</span>: <span id="moves">0</span></div>
        <div><span data-i18n="game.pairs">Pairs</span>: <span id="pairs">0</span>/<span id="totalPairs">8</span></div>
        <div>‚è±Ô∏è <span id="time">0</span>s</div>
    </div>
    
    <div class="level-select">
        <button class="level-btn active" data-level="easy" data-i18n="level.easy">Easy (8)</button>
        <button class="level-btn" data-level="medium" data-i18n="level.medium">Medium (12)</button>
        <button class="level-btn" data-level="hard" data-i18n="level.hard">Hard (15)</button>
    </div>
    
    <div class="game-board" id="gameBoard"></div>
    
    <div class="message" id="message" data-i18n="memoryMatch.instruction">Find all matching pairs!</div>
    
    <button id="startBtn" class="start-btn" style="display:none">Start Game</button>
    
    <div class="high-score" id="highScoreDisplay">Best: -- moves</div>
    <p class="info" style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Score is based on fewest moves</p>
    
    <div id="gameOver">
        <h2 data-i18n="memoryMatch.result">üéâ You Won!</h2>
        <p><span data-i18n="game.moves">Moves</span>: <span id="finalMoves">0</span></p>
        <p><span data-i18n="game.time">Time</span>: <span id="finalTime">0</span> <span data-i18n="game.seconds">seconds</span></p>
        <p id="highScoreMsg"></p>
        <button class="start-btn" onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const emojis = ['üê∂', 'üê±', 'üêº', 'ü¶ä', 'üê∏', 'ü¶ã', 'üå∏', '‚≠ê', 'üçé', 'üéà', 'üåü', 'üçï', 'üöó', 'üåû', 'üçí'];
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let gameTimer = null;
        let timeElapsed = 0;
        let canFlip = true;
        let currentLevel = 'easy';
        let pairsNeeded = 8;
        
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        // Adjust available levels based on grade
        function initGradeLevels() {
            const levelBtns = document.querySelectorAll('.level-btn');
            if (gradeLevel === 'kg') {
                // KG: Only easy (6 pairs)
                pairsNeeded = 6;
                levelBtns.forEach(btn => {
                    if (btn.dataset.level !== 'easy') btn.style.display = 'none';
                });
            } else if (gradeLevel === 'g1-3') {
                // Grade 1-3: Easy (8) and Medium (12), no Hard
                pairsNeeded = 8;
                levelBtns.forEach(btn => {
                    if (btn.dataset.level === 'hard') btn.style.display = 'none';
                });
            }
            // Grade 3-6: All levels including Hard (default)
        }
        
        function getHighScoreKey() {
            return `memoryMatch_${currentLevel}`;
        }
        
        function loadHighScore() {
            const key = getHighScoreKey();
            const storedScore = GameUtils.getHighScore(key);
            if (storedScore > 0) {
                const bestMoves = 1000 - storedScore; // Convert back to moves
                const bestPlayer = GameUtils.getHighScorePlayerName(key);
                const bestTime = localStorage.getItem(key + '_time') || '?';
                const bestLabel = typeof I18n !== 'undefined' ? I18n.t('game.best') : 'Best';
                const movesLabel = typeof I18n !== 'undefined' ? I18n.t('game.moves').toLowerCase() : 'moves';
                const byLabel = typeof I18n !== 'undefined' ? I18n.t('game.by') : 'by';
                document.getElementById('highScoreDisplay').innerHTML = 
                    `üèÜ ${bestLabel}: ${bestMoves} ${movesLabel} in ${bestTime}s ${byLabel} ${bestPlayer}`;
            } else {
                const bestLabel = typeof I18n !== 'undefined' ? I18n.t('game.best') : 'Best';
                const movesLabel = typeof I18n !== 'undefined' ? I18n.t('game.moves').toLowerCase() : 'moves';
                document.getElementById('highScoreDisplay').innerHTML = `${bestLabel}: -- ${movesLabel}`;
            }
        }
        
        function saveHighScore(movesCount, time) {
            // For memory match, lower moves is better, so we invert the logic
            // We'll store 1000 - moves as "score" so higher is better for GameUtils
            const key = getHighScoreKey();
            const currentHigh = GameUtils.getHighScore(key);
            const currentTime = parseInt(localStorage.getItem(key + '_time')) || 9999;
            const scoreValue = 1000 - movesCount; // Convert to "higher is better"
            
            // New high if: fewer moves OR same moves but faster time
            if (currentHigh === 0 || scoreValue > currentHigh || (scoreValue === currentHigh && time < currentTime)) {
                GameUtils.saveHighScore(key, scoreValue, playerName);
                localStorage.setItem(key + '_time', time);
                return true;
            }
            return false;
        }
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function createBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            board.classList.remove('cols-5');
            
            const selectedEmojis = emojis.slice(0, pairsNeeded);
            cards = shuffle([...selectedEmojis, ...selectedEmojis]);
            
            if (pairsNeeded <= 8) {
                board.style.gridTemplateColumns = 'repeat(4, 1fr)';
            } else if (pairsNeeded <= 12) {
                board.style.gridTemplateColumns = 'repeat(4, 1fr)';
            } else {
                board.style.gridTemplateColumns = 'repeat(5, 1fr)';
                board.classList.add('cols-5');
            }
            
            cards.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.emoji = emoji;
                card.innerHTML = `<span class="emoji">${emoji}</span>`;
                card.addEventListener('click', () => flipCard(card));
                card.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    flipCard(card);
                });
                board.appendChild(card);
            });
        }
        
        function flipCard(card) {
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            GameUtils.playSound('click');
            card.classList.add('flipped');
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                moves++;
                document.getElementById('moves').textContent = moves;
                canFlip = false;
                
                const [card1, card2] = flippedCards;
                
                if (card1.dataset.emoji === card2.dataset.emoji) {
                    // Match found!
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        matchedPairs++;
                        document.getElementById('pairs').textContent = matchedPairs;
                        document.getElementById('message').textContent = typeof I18n !== 'undefined' ? I18n.t('memoryMatch.matchFound') : '‚ú® Match found!';
                        GameUtils.playSound('correct');
                        
                        if (matchedPairs === pairsNeeded) {
                            endGame();
                        }
                        
                        flippedCards = [];
                        canFlip = true;
                    }, 300);
                } else {
                    // No match
                    GameUtils.playSound('wrong');
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        document.getElementById('message').textContent = typeof I18n !== 'undefined' ? I18n.t('game.wrong') : 'Try again!';
                        flippedCards = [];
                        canFlip = true;
                    }, 800);
                }
            }
        }
        
        function startTimer() {
            timeElapsed = 0;
            document.getElementById('time').textContent = '0';
            gameTimer = setInterval(() => {
                timeElapsed++;
                document.getElementById('time').textContent = timeElapsed;
            }, 1000);
        }
        
        function stopTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }
        
        function getPreviewTime() {
            // Preview time in milliseconds based on grade level
            if (gradeLevel === 'kg') return 5000;      // 5 seconds for KG
            if (gradeLevel === 'g1-3') return 3500;    // 3.5 seconds for grades 1-3
            return 2500;                               // 2.5 seconds for grades 3-6
        }
        
        function startGame() {
            stopTimer();
            matchedPairs = 0;
            moves = 0;
            flippedCards = [];
            canFlip = false; // Disable flipping during preview
            
            document.getElementById('moves').textContent = '0';
            document.getElementById('pairs').textContent = '0';
            document.getElementById('totalPairs').textContent = pairsNeeded;
            document.getElementById('gameOver').style.display = 'none';
            
            createBoard();
            
            // Show all cards for preview
            const allCards = document.querySelectorAll('.card');
            allCards.forEach(card => card.classList.add('flipped'));
            
            const previewTime = getPreviewTime();
            const memorizeText = typeof I18n !== 'undefined' ? I18n.t('memoryMatch.memorize') : 'Memorize the cards!';
            document.getElementById('message').textContent = `${memorizeText} ${previewTime/1000}s...`;
            
            // Countdown and then hide cards
            let countdown = previewTime / 1000;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    const memorizeText = typeof I18n !== 'undefined' ? I18n.t('memoryMatch.memorize') : 'Memorize the cards!';
                    document.getElementById('message').textContent = `${memorizeText} ${countdown}s...`;
                }
            }, 1000);
            
            setTimeout(() => {
                clearInterval(countdownInterval);
                allCards.forEach(card => card.classList.remove('flipped'));
                document.getElementById('message').textContent = typeof I18n !== 'undefined' ? I18n.t('memoryMatch.instruction') : 'Find all matching pairs!';
                canFlip = true;
                startTimer();
            }, previewTime);
        }
        
        function endGame() {
            stopTimer();
            GameUtils.playSound('levelUp');
            
            const isNewHigh = saveHighScore(moves, timeElapsed);
            loadHighScore();
            
            document.getElementById('finalMoves').textContent = moves;
            document.getElementById('finalTime').textContent = timeElapsed;
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                highMsg.innerHTML = '<span class="new-high">üèÜ NEW BEST SCORE!</span>';
            } else {
                const goodJobText = typeof I18n !== 'undefined' ? I18n.t('result.goodJob', { name: playerName }) : 'Great job, ' + playerName + '!';
                highMsg.textContent = goodJobText;
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Level selection - restart game when changing level
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLevel = btn.dataset.level;
                if (currentLevel === 'easy') pairsNeeded = 8;
                else if (currentLevel === 'medium') pairsNeeded = 12;
                else pairsNeeded = 15;
                loadHighScore();
                startGame(); // Restart with new level
            });
        });
        
        // Initialize
        initGradeLevels();
        loadHighScore();

        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
