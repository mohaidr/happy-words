<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title data-i18n="colorMatch.title">Color Match üé®</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        h1 { white-space: nowrap; }
        
        .color-word {
            font-size: 48px;
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.95);
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .instruction {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .colors-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 400px;
            margin-bottom: 20px;
        }
        
        .colors-grid.grid-4 {
            grid-template-columns: repeat(4, 1fr);
            max-width: 450px;
        }
        
        .level-indicator {
            font-size: 14px;
            padding: 5px 15px;
            background: rgba(255,215,0,0.3);
            border-radius: 15px;
            margin-bottom: 10px;
        }
        
        .color-btn {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            border: 4px solid rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            border-color: white;
        }
        
        .color-btn.correct {
            animation: correctPulse 0.5s ease;
            border-color: #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .color-btn.wrong {
            animation: shake 0.5s ease;
            border-color: #ff0000;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .message {
            font-size: 24px;
            margin-bottom: 15px;
            min-height: 35px;
            text-align: center;
        }
        
        .streak-display {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .btn-game {
            background: linear-gradient(145deg, #667eea, #764ba2);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
            margin-top: 0;
        }
        
        .btn-game:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.3);
            border-radius: 10px;
            font-size: 14px;
        }
        
        .lives {
            font-size: 24px;
        }
        
        .btn-stop {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            border: none;
            padding: 10px 25px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255,107,107,0.4);
            margin-top: 10px;
        }
        
        .btn-stop:hover {
            transform: scale(1.05);
            background: linear-gradient(145deg, #ff5252, #e04040);
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../home.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-fun.html" class="category-btn" data-i18n="nav.fun">üéâ Fun</a>
        <h1 data-i18n="colorMatch.title">üé® Color Match</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
        <div><span data-i18n="game.round">Round</span>: <span id="round">1</span></div>
        <div class="lives">‚ù§Ô∏è <span id="lives">3</span></div>
    </div>
    
    <div class="color-word" id="colorWord">RED</div>
    
    <div class="instruction" data-i18n="colorMatch.instruction">Tap the color that matches the word!</div>
    
    <div class="level-indicator" id="levelIndicator">Level 1 - Easy</div>
    
    <div class="colors-grid" id="colorsGrid"></div>
    
    <div class="message" id="message"></div>
    
    <button class="btn-stop" id="stopBtn" onclick="endGame()" data-i18n="game.stop">üõë Stop Game</button>
    
    <div class="high-score" id="highScoreDisplay">Best: -- points</div>
    
    <div id="gameOver">
        <h2 data-i18n="colorMatch.result">üé® Great Matching!</h2>
        <p><span data-i18n="game.score">Score</span>: <span id="finalScore">0</span></p>
        <p id="highScoreMsg"></p>
        <button class="btn btn-game" onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        // Basic colors (for beginners)
        const basicColors = [
            { name: 'Red', key: 'color.red', hex: '#ff4444' },
            { name: 'Blue', key: 'color.blue', hex: '#4444ff' },
            { name: 'Green', key: 'color.green', hex: '#44aa44' },
            { name: 'Yellow', key: 'color.yellow', hex: '#ffee00' },
            { name: 'Orange', key: 'color.orange', hex: '#ff7700' },
            { name: 'Purple', key: 'color.purple', hex: '#9933cc' },
        ];
        
        // Intermediate colors
        const intermediateColors = [
            { name: 'Pink', key: 'color.pink', hex: '#ff69b4' },
            { name: 'Brown', key: 'color.brown', hex: '#8b4513' },
            { name: 'Black', key: 'color.black', hex: '#222222' },
            { name: 'White', key: 'color.white', hex: '#f5f5f5' },
            { name: 'Gray', key: 'color.gray', hex: '#777777' },
            { name: 'Gold', key: 'color.gold', hex: '#DAA520' },
        ];
        
        // Advanced colors
        const advancedColors = [
            { name: 'Cyan', key: 'color.cyan', hex: '#00CED1' },
            { name: 'Magenta', key: 'color.magenta', hex: '#FF00FF' },
            { name: 'Lime', key: 'color.lime', hex: '#32CD32' },
            { name: 'Navy', key: 'color.navy', hex: '#000080' },
            { name: 'Teal', key: 'color.teal', hex: '#008080' },
            { name: 'Maroon', key: 'color.maroon', hex: '#800000' },
        ];
        
        // Expert colors (similar/tricky shades)
        const expertColors = [
            { name: 'Coral', key: 'color.coral', hex: '#FF6347' },
            { name: 'Crimson', key: 'color.crimson', hex: '#DC143C' },
            { name: 'Indigo', key: 'color.indigo', hex: '#4B0082' },
            { name: 'Turquoise', key: 'color.turquoise', hex: '#40E0D0' },
            { name: 'Olive', key: 'color.olive', hex: '#6B8E23' },
            { name: 'Silver', key: 'color.silver', hex: '#C0C0C0' },
            { name: 'Lavender', key: 'color.lavender', hex: '#B57EDC' },
            { name: 'Beige', key: 'color.beige', hex: '#D2B48C' },
            { name: 'Salmon', key: 'color.salmon', hex: '#E9967A' },
            { name: 'Violet', key: 'color.violet', hex: '#8A2BE2' },
        ];
        
        // All colors combined
        const allColors = [...basicColors, ...intermediateColors, ...advancedColors, ...expertColors];
        
        // Helper to get translated color name
        function getColorName(color) {
            return typeof I18n !== 'undefined' ? I18n.t(color.key) : color.name;
        }
        
        let score = 0;
        let round = 0;
        let lives = 3;
        let level = 1;
        let streak = 0;
        
        let currentColor = null;
        let gameRunning = false;
        let canClick = true;
        
        const GAME_KEY = 'colorMatch';
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        function loadHighScore() {
            const saved = GameUtils.getHighScore(GAME_KEY);
            if (saved > 0) {
                const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
                const bestLabel = typeof I18n !== 'undefined' ? I18n.t('game.best') : 'Best';
                const pointsLabel = typeof I18n !== 'undefined' ? I18n.t('game.points') : 'points';
                const byLabel = typeof I18n !== 'undefined' ? I18n.t('game.by') : 'by';
                document.getElementById('highScoreDisplay').innerHTML = `üèÜ ${bestLabel}: ${saved} ${pointsLabel} ${byLabel} ${bestPlayer}`;
            }
        }
        
        // Get colors based on current difficulty level
        function getColorsForLevel() {
            if (gradeLevel === 'kg') {
                // KG always gets basic colors only
                if (level <= 2) return basicColors.slice(0, 4);
                if (level <= 4) return basicColors;
                return [...basicColors, ...intermediateColors.slice(0, 2)];
            }
            
            // Progressive color unlock based on level
            if (level <= 2) return basicColors;
            if (level <= 4) return [...basicColors, ...intermediateColors];
            if (level <= 6) return [...basicColors, ...intermediateColors, ...advancedColors];
            return allColors;
        }
        
        // Calculate level based on rounds completed
        function calculateLevel() {
            if (round <= 5) return 1;
            if (round <= 12) return 2;
            if (round <= 20) return 3;
            if (round <= 30) return 4;
            if (round <= 45) return 5;
            if (round <= 60) return 6;
            return 7;
        }
        
        // Get Stroop effect probability based on level
        function getStroopProbability() {
            if (gradeLevel === 'kg') return 0;
            const baseProbability = gradeLevel === 'g3-6' ? 0.3 : 0.15;
            return Math.min(baseProbability + (level - 1) * 0.08, 0.7);
        }
        
        // Get number of color buttons based on level
        function getButtonCount() {
            if (gradeLevel === 'kg') {
                return level <= 2 ? 4 : 6;
            }
            if (level <= 2) return 6;
            if (level <= 4) return 8;
            return 9;
        }
        
        // Update level indicator
        function updateLevelIndicator() {
            const levelNames = {
                1: { en: 'Easy', ar: 'ÿ≥ŸáŸÑ' },
                2: { en: 'Getting Harder', ar: 'ÿ£ÿµÿπÿ® ŸÇŸÑŸäŸÑÿßŸã' },
                3: { en: 'Medium', ar: 'ŸÖÿ™Ÿàÿ≥ÿ∑' },
                4: { en: 'Challenging', ar: 'ÿ™ÿ≠ÿØŸä' },
                5: { en: 'Hard', ar: 'ÿµÿπÿ®' },
                6: { en: 'Expert', ar: 'ÿÆÿ®Ÿäÿ±' },
                7: { en: 'Master', ar: 'ŸÖÿ≠ÿ™ÿ±ŸÅ' },
            };
            const lang = typeof I18n !== 'undefined' && I18n.currentLang === 'ar' ? 'ar' : 'en';
            const levelLabel = lang === 'ar' ? 'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ' : 'Level';
            const levelName = levelNames[level] ? levelNames[level][lang] : levelNames[7][lang];
            document.getElementById('levelIndicator').textContent = `${levelLabel} ${level} - ${levelName}`;
        }
        
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        
        function loadRound() {
            round++;
            document.getElementById('round').textContent = round;
            canClick = true;
            
            // Update level based on progress
            const newLevel = calculateLevel();
            if (newLevel !== level) {
                level = newLevel;
                updateLevelIndicator();
                // Bonus for reaching new level
                if (level > 1) {
                    score += level * 5;
                    document.getElementById('score').textContent = score;
                    GameUtils.playSound('levelUp');
                }
            }
            
            const availableColors = getColorsForLevel();
            
            // Pick target color
            currentColor = availableColors[Math.floor(Math.random() * availableColors.length)];
            
            // Display the word
            const wordEl = document.getElementById('colorWord');
            wordEl.textContent = getColorName(currentColor).toUpperCase();
            
            // Apply Stroop effect based on level and grade
            const stroopProbability = getStroopProbability();
            if (gradeLevel === 'kg') {
                // KG: show word in matching color (easier)
                wordEl.style.color = currentColor.hex;
            } else if (Math.random() < stroopProbability) {
                // Stroop effect: show word in different color
                const trickColors = availableColors.filter(c => c.name !== currentColor.name);
                const trickColor = trickColors[Math.floor(Math.random() * trickColors.length)];
                wordEl.style.color = trickColor.hex;
            } else {
                wordEl.style.color = '#333';
            }
            
            // Create color buttons
            const grid = document.getElementById('colorsGrid');
            grid.innerHTML = '';
            
            const numButtons = getButtonCount();
            
            // Adjust grid layout based on button count
            if (numButtons > 6) {
                grid.classList.add('grid-4');
            } else {
                grid.classList.remove('grid-4');
            }
            
            // Select colors to show (always include correct answer)
            let displayColors = [currentColor];
            const others = shuffle(availableColors.filter(c => c.name !== currentColor.name));
            
            // For higher levels, include similar colors as distractors
            displayColors = displayColors.concat(others.slice(0, numButtons - 1));
            displayColors = shuffle(displayColors);
            
            displayColors.forEach(color => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color.hex;
                // Smaller buttons for larger grids
                if (numButtons > 6) {
                    btn.style.width = '80px';
                    btn.style.height = '80px';
                }
                btn.onclick = () => checkAnswer(color, btn);
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    checkAnswer(color, btn);
                });
                grid.appendChild(btn);
            });
            
            document.getElementById('message').textContent = '';
        }
        
        function checkAnswer(color, btn) {
            if (!gameRunning || !canClick) return;
            canClick = false;
            
            if (color.name === currentColor.name) {
                // Correct!
                streak++;
                // Bonus points for streaks and higher levels
                const basePoints = 10;
                const levelBonus = level * 2;
                const streakBonus = streak >= 5 ? Math.floor(streak / 5) * 5 : 0;
                const pointsEarned = basePoints + levelBonus + streakBonus;
                
                score += pointsEarned;
                document.getElementById('score').textContent = score;
                
                let message = typeof I18n !== 'undefined' ? I18n.t('game.correct') : '‚úì Correct!';
                if (streakBonus > 0) {
                    message += ` üî• ${streak}`;
                }
                document.getElementById('message').textContent = message;
                btn.classList.add('correct');
                GameUtils.playSound('correct');
                
                setTimeout(() => {
                    btn.classList.remove('correct');
                    loadRound();
                }, 600);
            } else {
                // Wrong
                streak = 0;
                lives--;
                document.getElementById('lives').textContent = lives;
                document.getElementById('message').textContent = typeof I18n !== 'undefined' ? I18n.t('game.wrong') : '‚úó Try again!';
                btn.classList.add('wrong');
                GameUtils.playSound('wrong');
                
                setTimeout(() => {
                    btn.classList.remove('wrong');
                    if (lives <= 0) {
                        endGame();
                    } else {
                        canClick = true;
                    }
                }, 600);
            }
        }
        
        function startGame() {
            score = 0;
            round = 0;
            level = 1;
            streak = 0;
            lives = GameUtils.getMaxLives({kg: 6, 'g1-3': 5, default: 4});
            gameRunning = true;
            
            document.getElementById('score').textContent = '0';
            document.getElementById('lives').textContent = lives;
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            updateLevelIndicator();
            
            loadRound();
        }
        
        function endGame() {
            gameRunning = false;
            document.getElementById('stopBtn').style.display = 'none';
            
            const isNewHigh = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            loadHighScore();
            
            document.getElementById('finalScore').textContent = score;
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                const newRecordText = typeof I18n !== 'undefined' ? I18n.t('game.newRecord') : 'üèÜ NEW HIGH SCORE!';
                highMsg.innerHTML = `<span class="new-high">${newRecordText}</span>`;
                GameUtils.playSound('levelUp');
            } else {
                const goodJobText = typeof I18n !== 'undefined' ? I18n.t('game.goodJob') : 'Good job!';
                highMsg.textContent = goodJobText + ' ' + playerName;
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Initialize
        loadHighScore();
        
        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
