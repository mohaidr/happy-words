<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Sorting Fun üì¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            user-select: none;
        }
        
        h1 { white-space: nowrap; }
        
        .category-name {
            font-size: 20px;
            margin-bottom: 10px;
            text-align: center;
            background: rgba(0,0,0,0.2);
            padding: 8px 20px;
            border-radius: 15px;
        }
        
        .bins-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .bin {
            width: 150px;
            min-height: 120px;
            background: rgba(255,255,255,0.15);
            border: 3px dashed rgba(255,255,255,0.5);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            transition: all 0.3s ease;
        }
        
        .bin.drag-over {
            background: rgba(255,255,255,0.3);
            border-color: white;
            transform: scale(1.05);
        }
        
        .bin-label {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .bin-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .bin-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }
        
        .items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 350px;
            min-height: 80px;
            background: rgba(0,0,0,0.15);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .item {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .item:hover {
            transform: scale(1.1);
        }
        
        .item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .item.sorted {
            width: 40px;
            height: 40px;
            font-size: 22px;
            cursor: default;
            animation: popIn 0.3s ease;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .item.wrong {
            animation: shake 0.5s ease;
            background: #ffcccc;
        }
        
        .message {
            font-size: 18px;
            margin-bottom: 15px;
            min-height: 25px;
            text-align: center;
        }
        
        button {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255,107,107,0.6);
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.3);
            border-radius: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../index.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-logic.html" class="category-btn" data-i18n="nav.logic">üß† Logic</a>
        <h1 data-i18n="sortingFun.title">üì¶ Sorting Fun</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
        <div><span data-i18n="game.round">Round</span>: <span id="round">1</span>/5</div>
        <div>‚è±Ô∏è <span id="time">0</span>s</div>
    </div>
    
    <div class="category-name" id="categoryName"></div>
    
    <div class="bins-container" id="binsContainer"></div>
    
    <div class="items-container" id="itemsContainer"></div>
    
    <div class="message" id="message" data-i18n="sortingFun.dragInstruction">Drag items to the correct bins!</div>
    
    <button id="startBtn" style="display: none;">Start Game</button>
    
    <div class="high-score" id="highScoreDisplay">Best: -- points</div>
    
    <div id="gameOver">
        <h2 data-i18n="sortingFun.result">üéâ Great Sorting!</h2>
        <p><span data-i18n="game.score">Score</span>: <span id="finalScore">0</span></p>
        <p id="finalTimeText"></p>
        <p id="highScoreMsg"></p>
        <button onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_KEY = 'sortingFun';
        
        // Helper to get translation
        function t(key, params) {
            return typeof I18n !== 'undefined' ? I18n.t(key, params) : key;
        }
        
        const categories = [
            // Easy categories (KG friendly)
            {
                nameKey: 'sortingFun.cat.animalsVsFood',
                bins: [
                    { labelKey: 'sortingFun.bin.animals', icon: 'üêæ', items: ['üê∂', 'üê±', 'üê∞', 'üê∏', 'ü¶ã', 'üêº'] },
                    { labelKey: 'sortingFun.bin.food', icon: 'üçΩÔ∏è', items: ['üçé', 'üçï', 'üçî', 'üç¶', 'üßÅ', 'üç©'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.landVsWater',
                bins: [
                    { labelKey: 'sortingFun.bin.land', icon: 'üå≤', items: ['üêï', 'üêà', 'ü¶Å', 'üêò', 'üêøÔ∏è', 'ü¶î'] },
                    { labelKey: 'sortingFun.bin.water', icon: 'üåä', items: ['üê†', 'üêô', 'ü¶à', 'üê≥', 'ü¶Ä', 'üê¨'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.bigVsSmall',
                bins: [
                    { labelKey: 'sortingFun.bin.big', icon: 'üêò', items: ['üêò', 'ü¶í', 'üêã', 'üè†', 'üöå', 'üå≥'] },
                    { labelKey: 'sortingFun.bin.small', icon: 'üêú', items: ['üêú', 'üêù', 'ü¶ó', 'üçì', 'üîë', 'üíé'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.clothesVsToys',
                bins: [
                    { labelKey: 'sortingFun.bin.clothes', icon: 'üëï', items: ['üëï', 'üëñ', 'üß¢', 'üëü', 'üß§', 'üß£'] },
                    { labelKey: 'sortingFun.bin.toys', icon: 'üß∏', items: ['üß∏', 'üéÆ', 'ü™Ä', 'üéØ', 'ü™Å', 'üé≤'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.fruitsVsVegetables',
                bins: [
                    { labelKey: 'sortingFun.bin.fruits', icon: 'üçá', items: ['üçé', 'üçå', 'üçä', 'üçì', 'üçë', 'ü•ù'] },
                    { labelKey: 'sortingFun.bin.vegetables', icon: 'ü•¨', items: ['ü•ï', 'ü•¶', 'üåΩ', 'üçÜ', 'ü•í', 'ü´ë'] }
                ]
            },
            // Medium categories (Grades 1-3)
            {
                nameKey: 'sortingFun.cat.hotVsCold',
                bins: [
                    { labelKey: 'sortingFun.bin.cold', icon: '‚ùÑÔ∏è', items: ['‚ùÑÔ∏è', '‚õÑ', 'üßä', 'üç¶', 'ü•∂', 'üå®Ô∏è'] },
                    { labelKey: 'sortingFun.bin.hot', icon: 'üî•', items: ['‚òÄÔ∏è', 'üå∂Ô∏è', 'üçµ', 'üî•', 'üåã', '‚ô®Ô∏è'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.skyVsGround',
                bins: [
                    { labelKey: 'sortingFun.bin.sky', icon: '‚òÅÔ∏è', items: ['‚úàÔ∏è', 'ü¶Ö', '‚òÅÔ∏è', '‚≠ê', 'üåô', 'üéà'] },
                    { labelKey: 'sortingFun.bin.ground', icon: 'üåç', items: ['üöó', 'üè†', 'üå≥', 'üêú', 'ü™®', 'üå∏'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.dayVsNight',
                bins: [
                    { labelKey: 'sortingFun.bin.day', icon: '‚òÄÔ∏è', items: ['‚òÄÔ∏è', 'üå§Ô∏è', '‚òÅÔ∏è', 'ü¶ã', 'üêù', 'üåª'] },
                    { labelKey: 'sortingFun.bin.night', icon: 'üåô', items: ['üåô', '‚≠ê', 'ü¶â', 'ü¶á', 'üåÉ', 'üî¶'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.sweetVsSour',
                bins: [
                    { labelKey: 'sortingFun.bin.sweet', icon: 'üç¨', items: ['üç¨', 'üç≠', 'üç™', 'üéÇ', 'üç´', 'üçØ'] },
                    { labelKey: 'sortingFun.bin.sour', icon: 'üçã', items: ['üçã', 'ü•í', 'üçè', 'ü•ù', 'üçä', 'ü´í'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.fastVsSlow',
                bins: [
                    { labelKey: 'sortingFun.bin.fast', icon: 'üöÄ', items: ['üöÄ', '‚úàÔ∏è', 'üèéÔ∏è', '‚ö°', 'üêÜ', 'ü¶Ö'] },
                    { labelKey: 'sortingFun.bin.slow', icon: 'üê¢', items: ['üê¢', 'üêå', 'ü¶•', 'üêõ', 'üö∂', 'üêò'] }
                ]
            },
            // Harder categories (Grades 3-6)
            {
                nameKey: 'sortingFun.cat.indoorVsOutdoor',
                bins: [
                    { labelKey: 'sortingFun.bin.indoor', icon: 'üè†', items: ['üõãÔ∏è', 'üõèÔ∏è', 'üì∫', 'üöø', 'üç≥', 'üí°'] },
                    { labelKey: 'sortingFun.bin.outdoor', icon: 'üå≥', items: ['üå≥', 'üåª', '‚õ∫', 'üèïÔ∏è', 'üé°', 'üèñÔ∏è'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.summerVsWinter',
                bins: [
                    { labelKey: 'sortingFun.bin.summer', icon: 'üåû', items: ['üåû', 'üèñÔ∏è', 'üç¶', 'ü©±', 'üï∂Ô∏è', '‚õ±Ô∏è'] },
                    { labelKey: 'sortingFun.bin.winter', icon: '‚õÑ', items: ['‚õÑ', 'üß£', 'üéø', '‚òÉÔ∏è', 'üß§', 'üõ∑'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.schoolVsHome',
                bins: [
                    { labelKey: 'sortingFun.bin.school', icon: 'üè´', items: ['üìö', '‚úèÔ∏è', 'üìê', 'üéí', 'üìù', 'üñçÔ∏è'] },
                    { labelKey: 'sortingFun.bin.home', icon: 'üè†', items: ['üõèÔ∏è', 'üç≥', 'üì∫', 'üõãÔ∏è', 'üß∏', 'üöø'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.healthyVsJunk',
                bins: [
                    { labelKey: 'sortingFun.bin.healthy', icon: 'ü•ó', items: ['ü•ó', 'ü•ï', 'üçé', 'ü•¶', 'üçå', 'üí™'] },
                    { labelKey: 'sortingFun.bin.junk', icon: 'üçî', items: ['üçî', 'üçü', 'üçï', 'üç©', 'üç´', 'ü•§'] }
                ]
            },
            {
                nameKey: 'sortingFun.cat.softVsHard',
                bins: [
                    { labelKey: 'sortingFun.bin.soft', icon: 'üß∏', items: ['üß∏', '‚òÅÔ∏è', 'üõèÔ∏è', 'üßÅ', 'üêë', 'üéÄ'] },
                    { labelKey: 'sortingFun.bin.hard', icon: 'ü™®', items: ['ü™®', 'üíé', 'üß±', 'üî©', 'üè†', 'ü¶¥'] }
                ]
            }
        ];
        
        let currentCategory = null;
        let usedCategories = [];
        let score = 0;
        let round = 1;
        let totalRounds = 5;
        let itemsToSort = [];
        let gameTimer = null;
        let timeElapsed = 0;
        let draggedItem = null;
        
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        // Get all categories for all levels
        function getCategories() {
            return categories;
        }
        
        // Get number of items per bin based on grade
        function getItemsPerBin() {
            if (gradeLevel === 'kg') return 2;
            if (gradeLevel === 'g1-3') return 3;
            return 3;
        }
        
        function loadHighScore() {
            const saved = GameUtils.getHighScore(GAME_KEY);
            if (saved > 0) {
                const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
                const highScoreText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.highScorePoints', { score: saved, player: bestPlayer })
                    : `üèÜ Best: ${saved} points by ${bestPlayer}`;
                document.getElementById('highScoreDisplay').innerHTML = highScoreText;
            } else {
                const defaultText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.defaultHighScore')
                    : 'Best: -- points';
                document.getElementById('highScoreDisplay').innerHTML = defaultText;
            }
        }
        
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        function setupRound() {
            // Pick random category based on grade, excluding already used ones
            const gradeCategories = getCategories();
            const availableCategories = gradeCategories.filter(c => !usedCategories.includes(c));
            currentCategory = availableCategories[Math.floor(Math.random() * availableCategories.length)];
            usedCategories.push(currentCategory);
            
            document.getElementById('categoryName').textContent = t(currentCategory.nameKey);
            
            // Setup bins
            const binsContainer = document.getElementById('binsContainer');
            binsContainer.innerHTML = '';
            
            currentCategory.bins.forEach((binData, index) => {
                const bin = document.createElement('div');
                bin.className = 'bin';
                bin.dataset.binIndex = index;
                bin.innerHTML = `
                    <div class="bin-icon">${binData.icon}</div>
                    <div class="bin-label">${t(binData.labelKey)}</div>
                    <div class="bin-items" id="binItems${index}"></div>
                `;
                
                // Drag events
                bin.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    bin.classList.add('drag-over');
                });
                
                bin.addEventListener('dragleave', () => {
                    bin.classList.remove('drag-over');
                });
                
                bin.addEventListener('drop', (e) => {
                    e.preventDefault();
                    bin.classList.remove('drag-over');
                    handleDrop(index);
                });
                
                // Touch support
                bin.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                });
                
                binsContainer.appendChild(bin);
            });
            
            // Setup items
            itemsToSort = [];
            const itemsPerBin = getItemsPerBin();
            currentCategory.bins.forEach((binData, binIndex) => {
                const selectedItems = shuffle(binData.items).slice(0, itemsPerBin);
                selectedItems.forEach(item => {
                    itemsToSort.push({ emoji: item, correctBin: binIndex });
                });
            });
            itemsToSort = shuffle(itemsToSort);
            
            renderItems();
        }
        
        function renderItems() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            
            itemsToSort.forEach((itemData, index) => {
                const item = document.createElement('div');
                item.className = 'item';
                item.textContent = itemData.emoji;
                item.draggable = true;
                item.dataset.index = index;
                
                // Drag events
                item.addEventListener('dragstart', (e) => {
                    draggedItem = index;
                    item.classList.add('dragging');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
                
                // Touch support
                let touchStartX, touchStartY;
                
                item.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    draggedItem = index;
                    item.classList.add('dragging');
                });
                
                item.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('touchend', (e) => {
                    item.classList.remove('dragging');
                    
                    const touch = e.changedTouches[0];
                    const bins = document.querySelectorAll('.bin');
                    
                    bins.forEach((bin, binIndex) => {
                        const rect = bin.getBoundingClientRect();
                        if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                            touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                            handleDrop(binIndex);
                        }
                    });
                    
                    draggedItem = null;
                });
                
                container.appendChild(item);
            });
        }
        
        function handleDrop(binIndex) {
            if (draggedItem === null) return;
            
            const itemData = itemsToSort[draggedItem];
            const itemElement = document.querySelector(`.item[data-index="${draggedItem}"]`);
            
            if (itemData.correctBin === binIndex) {
                // Correct!
                score += 10;
                document.getElementById('score').textContent = score;
                const correctMsg = typeof I18n !== 'undefined' ? I18n.t('game.correct') : '‚ú® Correct!';
                document.getElementById('message').textContent = correctMsg;
                GameUtils.playSound('correct');
                
                // Move to bin
                const binItems = document.getElementById(`binItems${binIndex}`);
                const sortedItem = document.createElement('div');
                sortedItem.className = 'item sorted';
                sortedItem.textContent = itemData.emoji;
                binItems.appendChild(sortedItem);
                
                // Remove from items
                itemsToSort.splice(draggedItem, 1);
                renderItems();
                
                // Check if round complete
                if (itemsToSort.length === 0) {
                    round++;
                    if (round > totalRounds) {
                        endGame();
                    } else {
                        document.getElementById('round').textContent = round;
                        const roundCompleteMsg = typeof I18n !== 'undefined' ? I18n.t('game.roundComplete') : 'üéâ Round complete!';
                        document.getElementById('message').textContent = roundCompleteMsg;
                        GameUtils.playSound('levelUp');
                        setTimeout(setupRound, 1000);
                    }
                }
            } else {
                // Wrong!
                score = Math.max(0, score - 5);
                document.getElementById('score').textContent = score;
                const wrongMsg = typeof I18n !== 'undefined' ? I18n.t('game.wrong') : '‚ùå Try again!';
                document.getElementById('message').textContent = wrongMsg;
                GameUtils.playSound('wrong');
                
                if (itemElement) {
                    itemElement.classList.add('wrong');
                    setTimeout(() => itemElement.classList.remove('wrong'), 500);
                }
            }
            
            draggedItem = null;
        }
        
        function startTimer() {
            timeElapsed = 0;
            document.getElementById('time').textContent = '0';
            gameTimer = setInterval(() => {
                timeElapsed++;
                document.getElementById('time').textContent = timeElapsed;
            }, 1000);
        }
        
        function stopTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }
        
        function startGame() {
            stopTimer();
            score = 0;
            round = 1;
            currentCategory = null;
            usedCategories = [];
            
            document.getElementById('score').textContent = '0';
            document.getElementById('round').textContent = '1';
            const dragText = typeof I18n !== 'undefined' ? I18n.t('sortingFun.dragInstruction') : 'Drag items to the correct bins!';
            document.getElementById('message').textContent = dragText;
            document.getElementById('gameOver').style.display = 'none';
            
            setupRound();
            startTimer();
        }
        
        function endGame() {
            stopTimer();
            
            const isNewHigh = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            loadHighScore();
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalTimeText').textContent = t('sortingFun.timeResult', { time: timeElapsed });
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                const newRecordText = typeof I18n !== 'undefined' ? I18n.t('game.newRecord') : 'üèÜ NEW HIGH SCORE!';
                highMsg.innerHTML = `<span class="new-high">${newRecordText}</span>`;
                GameUtils.playSound('levelUp');
            } else {
                const goodJobText = typeof I18n !== 'undefined' ? I18n.t('result.goodJob', { name: playerName }) : 'Great sorting, ' + playerName + '!';
                highMsg.textContent = goodJobText;
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Initialize
        loadHighScore();
        
        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load after translations are ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(() => startGame(), 100));
        } else {
            setTimeout(() => startGame(), 100);
        }
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
