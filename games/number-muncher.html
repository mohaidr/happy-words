<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Number Muncher üêõ</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 20px;
        }
        
        h1 { white-space: nowrap; }
        
        .stats {
            gap: 30px;
            font-size: 20px;
        }
        
        .rule-display {
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .rule-display span {
            color: #ffeb3b;
            font-weight: bold;
        }
        
        #gameArea {
            width: 320px;
            height: 400px;
            background: linear-gradient(180deg, #2d3436 0%, #636e72 100%);
            border-radius: 15px;
            border: 4px solid #222;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            position: relative;
        }
        
        .number-cell {
            background: linear-gradient(145deg, #dfe6e9, #b2bec3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .number-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .number-cell.correct {
            background: linear-gradient(145deg, #00b894, #00cec9);
            color: white;
            animation: munch 0.3s ease;
        }
        
        .number-cell.wrong {
            background: linear-gradient(145deg, #d63031, #e17055);
            color: white;
            animation: shake 0.3s ease;
        }
        
        .number-cell.eaten {
            background: transparent;
            color: transparent;
            pointer-events: none;
        }
        
        @keyframes munch {
            0% { transform: scale(1); }
            50% { transform: scale(0.8) rotate(10deg); }
            100% { transform: scale(0); }
        }
        
        .muncher {
            position: absolute;
            font-size: 40px;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 10;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
        }
        
        #gameOver h2 { color: #00b894; }
        
        .btn {
            background: linear-gradient(145deg, #fdcb6e, #e17055);
        }
        
        .lives {
            font-size: 24px;
        }
        
        .info {
            max-width: 320px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../home.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-math.html" class="category-btn" data-i18n="nav.math">üî¢ Math</a>
        <h1 data-i18n="numberMuncher.title">üêõ Number Muncher</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
        <div><span data-i18n="game.level">Level</span>: <span id="level">1</span></div>
        <div class="lives"><span data-i18n="game.lives">Lives</span>: ‚ù§Ô∏è <span id="lives">3</span></div>
    </div>
    
    <div class="rule-display">
        <span data-i18n="numberMuncher.munchThe">Munch the</span> <span id="ruleText">even numbers</span>!
    </div>
    
    <div id="gameArea">
        <div id="muncher" class="muncher">üêõ</div>
        <div id="gameOver">
            <h2 data-i18n="numberMuncher.result">üéâ Great Job!</h2>
            <p id="playerDisplay"></p>
            <p><span data-i18n="game.finalScore">Final Score</span>: <span id="finalScore">0</span></p>
            <p>üèÜ <span data-i18n="game.highScore">High Score</span>: <span id="highScore">0</span></p>
            <p><span data-i18n="game.levelReached">Level Reached</span>: <span id="finalLevel">1</span></p>
            <button class="btn" onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
            <a href="../home.html" class="home-link" data-i18n="game.backHome">‚Üê Back to Home</a>
        </div>
    </div>
    
    <p class="info" data-i18n="numberMuncher.instruction">Click or tap on numbers that match the rule. Don't eat the wrong ones!</p>
    <p class="info" id="bestScoreDisplay">üèÜ <span data-i18n="game.best">Best</span>: --</p>

    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_KEY = 'numberMuncher';
        
        let score = 0;
        let level = 1;
        let lives = 3;
        let gameRunning = false;
        
        let currentRule = null;
        let correctCount = 0;
        let targetCorrect = 8;
        
        // Use GameUtils for player data and high score
        let highScore = GameUtils.getHighScore(GAME_KEY);
        let playerName = GameUtils.getPlayerName();
        let gradeLevel = GameUtils.getGradeLevel();
        
        function loadHighScore() {
            const saved = GameUtils.getHighScore(GAME_KEY);
            if (saved > 0) {
                const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
                const highScoreText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.highScorePoints', { score: saved, player: bestPlayer })
                    : `üèÜ Best: ${saved} points by ${bestPlayer}`;
                document.getElementById('bestScoreDisplay').innerHTML = highScoreText;
            } else {
                const defaultText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.defaultHighScore')
                    : 'Best: -- points';
                document.getElementById('bestScoreDisplay').innerHTML = 'üèÜ ' + defaultText;
            }
        }
        
        // Grade-specific rules with i18n keys
        const rulesKG = [
            { key: "numberMuncher.lessThan5", name: "numbers less than 5", check: n => n < 5 },
            { key: "numberMuncher.greaterThan5", name: "numbers greater than 5", check: n => n > 5 },
            { key: "numberMuncher.number1", name: "number 1", check: n => n === 1 },
            { key: "numberMuncher.number5", name: "number 5", check: n => n === 5 },
        ];
        
        const rulesG13 = [
            { key: "numberMuncher.even", name: "even numbers", check: n => n % 2 === 0 },
            { key: "numberMuncher.odd", name: "odd numbers", check: n => n % 2 !== 0 },
            { key: "numberMuncher.multiples", n: 5, name: "multiples of 5", check: n => n % 5 === 0 },
            { key: "numberMuncher.lessThan10", name: "numbers less than 10", check: n => n < 10 },
            { key: "numberMuncher.greaterThan15", name: "numbers greater than 15", check: n => n > 15 },
            { key: "numberMuncher.between10and20", name: "numbers between 10-20", check: n => n >= 10 && n <= 20 },
        ];
        
        const rulesG36 = [
            { key: "numberMuncher.even", name: "even numbers", check: n => n % 2 === 0 },
            { key: "numberMuncher.odd", name: "odd numbers", check: n => n % 2 !== 0 },
            { key: "numberMuncher.multiples", n: 3, name: "multiples of 3", check: n => n % 3 === 0 },
            { key: "numberMuncher.multiples", n: 4, name: "multiples of 4", check: n => n % 4 === 0 },
            { key: "numberMuncher.multiples", n: 6, name: "multiples of 6", check: n => n % 6 === 0 },
            { key: "numberMuncher.multiples", n: 7, name: "multiples of 7", check: n => n % 7 === 0 },
            { key: "numberMuncher.primeNumbers", name: "prime numbers", check: n => isPrime(n) },
            { key: "numberMuncher.squareNumbers", name: "square numbers", check: n => Math.sqrt(n) % 1 === 0 },
        ];
        
        function getRuleName(rule) {
            if (typeof I18n !== 'undefined') {
                if (rule.n) {
                    return I18n.t(rule.key, { n: rule.n });
                }
                return I18n.t(rule.key);
            }
            return rule.name;
        }
        
        function isPrime(n) {
            if (n < 2) return false;
            for (let i = 2; i <= Math.sqrt(n); i++) {
                if (n % i === 0) return false;
            }
            return true;
        }
        
        function getRules() {
            if (gradeLevel === 'kg') return rulesKG;
            if (gradeLevel === 'g1-3') return rulesG13;
            return rulesG36;
        }
        
        function getNumberRange() {
            if (gradeLevel === 'kg') return 10;
            if (gradeLevel === 'g1-3') return 30;
            return 50;
        }
        
        const gameArea = document.getElementById('gameArea');
        const muncher = document.getElementById('muncher');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const livesEl = document.getElementById('lives');
        const ruleText = document.getElementById('ruleText');
        const gameOverEl = document.getElementById('gameOver');
        
        function generateNumbers() {
            // Clear existing cells (except muncher and game over)
            document.querySelectorAll('.number-cell').forEach(cell => cell.remove());
            
            const maxNum = getNumberRange();
            const gridSize = Math.min(20, maxNum); // Don't exceed available numbers
            
            // Build pool of all numbers
            const allNumbers = [];
            const correctPool = [];
            const wrongPool = [];
            
            for (let i = 1; i <= maxNum; i++) {
                allNumbers.push(i);
                if (currentRule.check(i)) {
                    correctPool.push(i);
                } else {
                    wrongPool.push(i);
                }
            }
            
            // Shuffle pools
            correctPool.sort(() => Math.random() - 0.5);
            wrongPool.sort(() => Math.random() - 0.5);
            
            // Pick numbers: ensure at least some correct answers
            const numbers = [];
            const minCorrect = Math.min(5, correctPool.length);
            
            // Add correct answers first
            for (let i = 0; i < minCorrect && i < correctPool.length; i++) {
                numbers.push(correctPool[i]);
            }
            
            // Fill remaining with mix of correct and wrong
            const remaining = [...correctPool.slice(minCorrect), ...wrongPool];
            remaining.sort(() => Math.random() - 0.5);
            
            for (let i = 0; numbers.length < gridSize && i < remaining.length; i++) {
                numbers.push(remaining[i]);
            }
            
            // Shuffle final array
            numbers.sort(() => Math.random() - 0.5);
            
            // Update grid styling based on size
            const cols = numbers.length <= 12 ? 3 : 4;
            const rows = Math.ceil(numbers.length / cols);
            gameArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameArea.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            // Create cells
            numbers.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                cell.textContent = num;
                cell.dataset.number = num;
                cell.onclick = () => handleClick(cell, num);
                gameArea.appendChild(cell);
            });
        }
        
        function handleClick(cell, num) {
            if (!gameRunning || cell.classList.contains('eaten')) return;
            
            // Move muncher to cell
            const rect = cell.getBoundingClientRect();
            const areaRect = gameArea.getBoundingClientRect();
            muncher.style.left = (rect.left - areaRect.left + rect.width/2 - 20) + 'px';
            muncher.style.top = (rect.top - areaRect.top + rect.height/2 - 20) + 'px';
            
            if (currentRule.check(num)) {
                // Correct!
                cell.classList.add('correct');
                score += 10 * level;
                correctCount++;
                scoreEl.textContent = score;
                GameUtils.playSound('correct');
                
                setTimeout(() => {
                    cell.classList.remove('correct');
                    cell.classList.add('eaten');
                }, 300);
                
                // Check for level up
                if (correctCount >= targetCorrect) {
                    levelUp();
                }
            } else {
                // Wrong!
                cell.classList.add('wrong');
                lives--;
                livesEl.textContent = lives;
                GameUtils.playSound('wrong');
                
                setTimeout(() => {
                    cell.classList.remove('wrong');
                }, 300);
                
                if (lives <= 0) {
                    endGame();
                }
            }
        }
        
        function levelUp() {
            level++;
            levelEl.textContent = level;
            correctCount = 0;
            GameUtils.playSound('levelUp');
            
            // New rule every 2 levels
            if (level % 2 === 1) {
                const rules = getRules();
                currentRule = rules[Math.floor(Math.random() * rules.length)];
                ruleText.textContent = getRuleName(currentRule);
            }
            
            // Bonus life every 3 levels
            if (level % 3 === 0 && lives < 5) {
                lives++;
                livesEl.textContent = lives;
            }
            
            generateNumbers();
            updateTargetCorrect();
        }
        
        function updateTargetCorrect() {
            // Count actual correct numbers in the grid
            const cells = document.querySelectorAll('.number-cell');
            let total = 0;
            cells.forEach(cell => {
                if (currentRule.check(parseInt(cell.dataset.number))) total++;
            });
            targetCorrect = total; // Must eat all correct numbers to advance
        }
        
        function startGame() {
            score = 0;
            level = 1;
            correctCount = 0;
            
            // Refresh player data
            playerName = GameUtils.getPlayerName();
            gradeLevel = GameUtils.getGradeLevel();
            lives = GameUtils.getMaxLives({kg: 8, 'g1-3': 5, default: 3});
            gameRunning = true;
            
            // Refresh player data
            playerName = GameUtils.getPlayerName();
            gradeLevel = GameUtils.getGradeLevel();
            highScore = GameUtils.getHighScore(GAME_KEY);
            
            scoreEl.textContent = score;
            levelEl.textContent = level;
            livesEl.textContent = lives;
            gameOverEl.style.display = 'none';
            
            // Pick random rule
            const rules = getRules();
            currentRule = rules[Math.floor(Math.random() * rules.length)];
            ruleText.textContent = getRuleName(currentRule);
            
            // Reset muncher position
            muncher.style.left = '130px';
            muncher.style.top = '170px';
            
            generateNumbers();
            updateTargetCorrect();
        }
        
        function endGame() {
            gameRunning = false;
            
            // Save high score using GameUtils
            const isNewHighScore = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            if (isNewHighScore) {
                highScore = score;
            }
            
            const bestScore = Math.max(score, highScore);
            const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('highScore').textContent = `${bestScore} by ${bestPlayer}`;
            document.getElementById('highScore').textContent = Math.max(score, highScore);
            document.getElementById('playerDisplay').textContent = playerName + "'s Game";
            gameOverEl.style.display = 'block';
            loadHighScore();
        }

        // Initialize sound toggle
        GameUtils.initSoundToggle();
        loadHighScore();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
