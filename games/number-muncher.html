<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Muncher üêõ</title>
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 20px;
        }
        
        h1 { white-space: nowrap; }
        
        .stats {
            gap: 30px;
            font-size: 20px;
        }
        
        .rule-display {
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .rule-display span {
            color: #ffeb3b;
            font-weight: bold;
        }
        
        #gameArea {
            width: 320px;
            height: 400px;
            background: linear-gradient(180deg, #2d3436 0%, #636e72 100%);
            border-radius: 15px;
            border: 4px solid #222;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            position: relative;
        }
        
        .number-cell {
            background: linear-gradient(145deg, #dfe6e9, #b2bec3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .number-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .number-cell.correct {
            background: linear-gradient(145deg, #00b894, #00cec9);
            color: white;
            animation: munch 0.3s ease;
        }
        
        .number-cell.wrong {
            background: linear-gradient(145deg, #d63031, #e17055);
            color: white;
            animation: shake 0.3s ease;
        }
        
        .number-cell.eaten {
            background: transparent;
            color: transparent;
            pointer-events: none;
        }
        
        @keyframes munch {
            0% { transform: scale(1); }
            50% { transform: scale(0.8) rotate(10deg); }
            100% { transform: scale(0); }
        }
        
        .muncher {
            position: absolute;
            font-size: 40px;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 10;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 100;
        }
        
        #gameOver h2 { color: #00b894; margin-bottom: 15px; }
        #gameOver p { margin: 8px 0; font-size: 18px; }
        
        .btn {
            background: linear-gradient(145deg, #fdcb6e, #e17055);
        }
        
        .lives {
            font-size: 24px;
        }
        
        .info {
            max-width: 320px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../index.html" class="home-btn">‚Üê Home</a>
        <h1>üêõ Number Muncher</h1>
    </div>
    
    <div class="stats">
        <div>Score: <span id="score">0</span></div>
        <div>Level: <span id="level">1</span></div>
        <div class="lives">‚ù§Ô∏è <span id="lives">3</span></div>
    </div>
    
    <div class="rule-display">
        Munch the <span id="ruleText">even numbers</span>!
    </div>
    
    <div id="gameArea">
        <div id="muncher" class="muncher">üêõ</div>
        <div id="gameOver">
            <h2>üéâ Great Job!</h2>
            <p id="playerDisplay"></p>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>üèÜ High Score: <span id="highScore">0</span></p>
            <p>Level Reached: <span id="finalLevel">1</span></p>
            <button class="btn" onclick="startGame()">Play Again</button>
            <a href="../index.html" class="home-link">‚Üê Back to Home</a>
        </div>
    </div>
    
    <button class="btn" id="startBtn" onclick="startGame()">Start Game</button>
    
    <p class="info">Click or tap on numbers that match the rule. Don't eat the wrong ones!</p>

    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_KEY = 'numberMuncher';
        
        let score = 0;
        let level = 1;
        let lives = 3;
        let gameRunning = false;
        let currentRule = null;
        let correctCount = 0;
        let targetCorrect = 8;
        
        // Use GameUtils for player data and high score
        let highScore = GameUtils.getHighScore(GAME_KEY);
        let playerName = GameUtils.getPlayerName();
        let gradeLevel = GameUtils.getGradeLevel();
        
        // Grade-specific rules
        const rulesKG = [
            { name: "numbers less than 5", check: n => n < 5 },
            { name: "numbers greater than 5", check: n => n > 5 },
            { name: "the number 1", check: n => n === 1 },
            { name: "the number 5", check: n => n === 5 },
        ];
        
        const rulesG13 = [
            { name: "even numbers", check: n => n % 2 === 0 },
            { name: "odd numbers", check: n => n % 2 !== 0 },
            { name: "multiples of 5", check: n => n % 5 === 0 },
            { name: "numbers less than 10", check: n => n < 10 },
            { name: "numbers greater than 15", check: n => n > 15 },
            { name: "numbers between 10-20", check: n => n >= 10 && n <= 20 },
        ];
        
        const rulesG36 = [
            { name: "even numbers", check: n => n % 2 === 0 },
            { name: "odd numbers", check: n => n % 2 !== 0 },
            { name: "multiples of 3", check: n => n % 3 === 0 },
            { name: "multiples of 4", check: n => n % 4 === 0 },
            { name: "multiples of 6", check: n => n % 6 === 0 },
            { name: "multiples of 7", check: n => n % 7 === 0 },
            { name: "prime numbers", check: n => isPrime(n) },
            { name: "square numbers", check: n => Math.sqrt(n) % 1 === 0 },
        ];
        
        function isPrime(n) {
            if (n < 2) return false;
            for (let i = 2; i <= Math.sqrt(n); i++) {
                if (n % i === 0) return false;
            }
            return true;
        }
        
        function getRules() {
            if (gradeLevel === 'kg') return rulesKG;
            if (gradeLevel === 'g1-3') return rulesG13;
            return rulesG36;
        }
        
        function getNumberRange() {
            if (gradeLevel === 'kg') return 10;
            if (gradeLevel === 'g1-3') return 30;
            return 50;
        }
        
        const gameArea = document.getElementById('gameArea');
        const muncher = document.getElementById('muncher');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const livesEl = document.getElementById('lives');
        const ruleText = document.getElementById('ruleText');
        const gameOverEl = document.getElementById('gameOver');
        const startBtn = document.getElementById('startBtn');
        
        function generateNumbers() {
            // Clear existing cells (except muncher and game over)
            document.querySelectorAll('.number-cell').forEach(cell => cell.remove());
            
            // Generate 20 numbers for 4x5 grid
            const numbers = [];
            let correctNumbers = 0;
            const maxNum = getNumberRange();
            
            // Ensure at least 5 correct answers
            while (numbers.length < 20) {
                let num;
                if (correctNumbers < 5 && numbers.length < 15) {
                    // Force some correct answers
                    do {
                        num = Math.floor(Math.random() * maxNum) + 1;
                    } while (!currentRule.check(num) || numbers.includes(num));
                    correctNumbers++;
                } else {
                    num = Math.floor(Math.random() * maxNum) + 1;
                    if (!numbers.includes(num)) {
                        if (currentRule.check(num)) correctNumbers++;
                    } else {
                        continue;
                    }
                }
                if (!numbers.includes(num)) numbers.push(num);
            }
            
            // Shuffle
            numbers.sort(() => Math.random() - 0.5);
            
            // Create cells
            numbers.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                cell.textContent = num;
                cell.dataset.number = num;
                cell.onclick = () => handleClick(cell, num);
                gameArea.appendChild(cell);
            });
        }
        
        function handleClick(cell, num) {
            if (!gameRunning || cell.classList.contains('eaten')) return;
            
            // Move muncher to cell
            const rect = cell.getBoundingClientRect();
            const areaRect = gameArea.getBoundingClientRect();
            muncher.style.left = (rect.left - areaRect.left + rect.width/2 - 20) + 'px';
            muncher.style.top = (rect.top - areaRect.top + rect.height/2 - 20) + 'px';
            
            if (currentRule.check(num)) {
                // Correct!
                cell.classList.add('correct');
                score += 10 * level;
                correctCount++;
                scoreEl.textContent = score;
                GameUtils.playSound('correct');
                
                setTimeout(() => {
                    cell.classList.remove('correct');
                    cell.classList.add('eaten');
                }, 300);
                
                // Check for level up
                if (correctCount >= targetCorrect) {
                    levelUp();
                }
            } else {
                // Wrong!
                cell.classList.add('wrong');
                lives--;
                livesEl.textContent = lives;
                GameUtils.playSound('wrong');
                
                setTimeout(() => {
                    cell.classList.remove('wrong');
                }, 300);
                
                if (lives <= 0) {
                    endGame();
                }
            }
        }
        
        function levelUp() {
            level++;
            levelEl.textContent = level;
            correctCount = 0;
            GameUtils.playSound('levelUp');
            
            // New rule every 2 levels
            if (level % 2 === 1) {
                const rules = getRules();
                currentRule = rules[Math.floor(Math.random() * rules.length)];
                ruleText.textContent = currentRule.name;
            }
            
            // Bonus life every 3 levels
            if (level % 3 === 0 && lives < 5) {
                lives++;
                livesEl.textContent = lives;
            }
            
            generateNumbers();
        }
        
        function startGame() {
            score = 0;
            level = 1;
            lives = 3;
            correctCount = 0;
            gameRunning = true;
            
            // Refresh player data
            playerName = GameUtils.getPlayerName();
            gradeLevel = GameUtils.getGradeLevel();
            highScore = GameUtils.getHighScore(GAME_KEY);
            
            scoreEl.textContent = score;
            levelEl.textContent = level;
            livesEl.textContent = lives;
            gameOverEl.style.display = 'none';
            startBtn.style.display = 'none';
            
            // Pick random rule
            const rules = getRules();
            currentRule = rules[Math.floor(Math.random() * rules.length)];
            ruleText.textContent = currentRule.name;
            
            // Reset muncher position
            muncher.style.left = '130px';
            muncher.style.top = '170px';
            
            generateNumbers();
        }
        
        function endGame() {
            gameRunning = false;
            
            // Save high score using GameUtils
            const isNewHighScore = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            if (isNewHighScore) {
                highScore = score;
            }
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLevel').textContent = level;
            document.getElementById('highScore').textContent = Math.max(score, highScore);
            document.getElementById('playerDisplay').textContent = playerName + "'s Game";
            gameOverEl.style.display = 'block';
            startBtn.style.display = 'block';
        }
    </script>
</body>
</html>
