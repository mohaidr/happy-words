<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Pattern Puzzle üîÆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        h1 { white-space: nowrap; }
        
        .game-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            background: transparent;
            padding: 30px;
        }
        
        .color-btn {
            width: 130px;
            height: 130px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 4px solid rgba(255,255,255,0.2);
            opacity: 0.7;
        }
        
        .color-btn:hover {
            opacity: 0.9;
        }
        
        .color-btn.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 30px currentColor;
        }
        
        .color-btn.red {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            color: #ff6b6b;
        }
        
        .color-btn.blue {
            background: linear-gradient(145deg, #4ecdc4, #45b7aa);
            color: #4ecdc4;
        }
        
        .color-btn.yellow {
            background: linear-gradient(145deg, #ffe66d, #ffd93d);
            color: #ffe66d;
        }
        
        .color-btn.green {
            background: linear-gradient(145deg, #6bcb77, #5cb868);
            color: #6bcb77;
        }
        
        .message {
            font-size: 22px;
            margin-bottom: 20px;
            min-height: 35px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .start-btn {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233,69,96,0.4);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(233,69,96,0.6);
        }
        
        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.2);
            border-radius: 10px;
            font-size: 14px;
        }
        
#gameOver button {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233,69,96,0.4);
        }
        
        #gameOver button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(233,69,96,0.6);
        }
        
        .pattern-indicator {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            min-height: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .pattern-indicator.hidden {
            visibility: hidden;
        }
        
        .hints-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .hints-toggle input {
            display: none;
        }
        
        .hints-toggle .toggle-switch {
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .hints-toggle .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .hints-toggle input:checked + .toggle-switch {
            background: linear-gradient(145deg, #6bcb77, #5cb868);
        }
        
        .hints-toggle input:checked + .toggle-switch::after {
            left: 25px;
        }
        
        .hints-toggle label {
            cursor: pointer;
            user-select: none;
        }
        
        .pattern-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            opacity: 0.5;
        }
        
        .pattern-dot.current {
            opacity: 1;
            box-shadow: 0 0 10px currentColor;
        }
        
        .pattern-dot.done {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../home.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>        <a href="category-logic.html" class="category-btn" data-i18n="nav.logic">üß† Logic</a>        <h1 data-i18n="patternPuzzle.title">üîÆ Pattern Puzzle</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.level">Level</span>: <span id="level">1</span></div>
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
    </div>
    
    <div class="hints-toggle" onclick="document.getElementById('hintsToggle').click()">
        <input type="checkbox" id="hintsToggle">
        <span class="toggle-switch"></span>
        <label for="hintsToggle" data-i18n="patternPuzzle.showHints">‚ú® Show hints</label>
    </div>
    
    <div class="pattern-indicator" id="patternIndicator"></div>
    
    <div class="game-area">
        <div class="color-btn red" data-color="red"></div>
        <div class="color-btn blue" data-color="blue"></div>
        <div class="color-btn yellow" data-color="yellow"></div>
        <div class="color-btn green" data-color="green"></div>
    </div>
    
    <div class="message" id="message">Watch the pattern!</div>
    
    <button class="start-btn" id="startBtn" style="display: none;">Start Game</button>
    
    <div class="high-score" id="highScoreDisplay">Best Level: --</div>
    
    <div id="gameOver">
        <h2 id="gameOverTitle" data-i18n="patternPuzzle.result">Game Over!</h2>
        <p id="reachedLevelText"></p>
        <p id="scoreText"></p>
        <p id="highScoreMsg"></p>
        <button onclick="startGame()" data-i18n="game.playAgain">Try Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const colors = ['red', 'blue', 'yellow', 'green'];
        let pattern = [];
        let playerPattern = [];
        let level = 1;
        let score = 0;
        let isPlaying = false;
        let isShowingPattern = false;
        
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        // Get flash duration based on grade (slower for younger kids)
        function getFlashDuration() {
            if (gradeLevel === 'kg') {
                return Math.max(400, 700 - level * 15);
            } else if (gradeLevel === 'g1-3') {
                return Math.max(300, 500 - level * 20);
            }
            return Math.max(200, 400 - level * 25);
        }
        
        function loadHighScore() {
            const highScoreData = localStorage.getItem('patternPuzzle_highScore');
            if (highScoreData) {
                const data = JSON.parse(highScoreData);
                const highScoreText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.highScoreLevel', { level: data.level, player: data.name })
                    : `üèÜ Best: Level ${data.level} by ${data.name}`;
                document.getElementById('highScoreDisplay').innerHTML = highScoreText;
            } else {
                const defaultText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.defaultHighScoreLevel')
                    : 'Best Level: --';
                document.getElementById('highScoreDisplay').innerHTML = defaultText;
            }
        }
        
        function saveHighScore(levelReached, scoreValue) {
            const saved = localStorage.getItem('patternPuzzle_highScore');
            const current = saved ? JSON.parse(saved) : null;
            
            if (!current || levelReached > current.level) {
                localStorage.setItem('patternPuzzle_highScore', JSON.stringify({
                    level: levelReached,
                    score: scoreValue,
                    name: playerName
                }));
                return true;
            }
            return false;
        }
        
        function flashButton(color, duration = 400) {
            return new Promise(resolve => {
                const btn = document.querySelector(`.color-btn.${color}`);
                btn.classList.add('active');
                GameUtils.playSound('click');
                setTimeout(() => {
                    btn.classList.remove('active');
                    setTimeout(resolve, 100);
                }, duration);
            });
        }
        
        function updatePatternIndicator() {
            const indicator = document.getElementById('patternIndicator');
            const hintsEnabled = document.getElementById('hintsToggle').checked;
            
            indicator.classList.toggle('hidden', !hintsEnabled);
            indicator.innerHTML = '';
            
            pattern.forEach((color, index) => {
                const dot = document.createElement('div');
                dot.className = `pattern-dot`;
                dot.style.backgroundColor = getColorValue(color);
                dot.style.color = getColorValue(color);
                
                if (index < playerPattern.length) {
                    dot.classList.add('done');
                } else if (index === playerPattern.length) {
                    dot.classList.add('current');
                }
                
                indicator.appendChild(dot);
            });
        }
        
        function getColorValue(color) {
            const values = {
                red: '#ff6b6b',
                blue: '#4ecdc4',
                yellow: '#ffe66d',
                green: '#6bcb77'
            };
            return values[color];
        }
        
        async function showPattern() {
            isShowingPattern = true;
            const watchText = typeof I18n !== 'undefined' ? I18n.t('patternPuzzle.watch') : 'Watch carefully...';
            document.getElementById('message').textContent = watchText;
            
            updatePatternIndicator();
            
            await new Promise(r => setTimeout(r, 500));
            
            for (const color of pattern) {
                await flashButton(color, getFlashDuration());
            }
            
            isShowingPattern = false;
            const yourTurnText = typeof I18n !== 'undefined' ? I18n.t('patternPuzzle.yourTurn') : 'Your turn! Repeat the pattern';
            document.getElementById('message').textContent = yourTurnText;
            playerPattern = [];
            updatePatternIndicator();
        }
        
        function addToPattern() {
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            pattern.push(randomColor);
        }
        
        async function handleColorClick(color) {
            if (!isPlaying || isShowingPattern) return;
            
            await flashButton(color, 200);
            playerPattern.push(color);
            updatePatternIndicator();
            
            // Check if correct
            const currentIndex = playerPattern.length - 1;
            
            if (playerPattern[currentIndex] !== pattern[currentIndex]) {
                // Wrong!
                GameUtils.playSound('wrong');
                gameOver();
                return;
            }
            
            // Check if pattern complete
            if (playerPattern.length === pattern.length) {
                GameUtils.playSound('correct');
                score += level * 10;
                document.getElementById('score').textContent = score;
                
                level++;
                document.getElementById('level').textContent = level;
                const perfectText = typeof I18n !== 'undefined' ? I18n.t('patternPuzzle.perfect') : '‚ú® Perfect! Next level...';
                document.getElementById('message').textContent = perfectText;
                
                if (level % 3 === 0) {
                    GameUtils.playSound('levelUp');
                }
                
                addToPattern();
                
                setTimeout(() => {
                    playerPattern = [];
                    showPattern();
                }, 1000);
            }
        }
        
        function gameOver() {
            isPlaying = false;
            
            const isNewHigh = saveHighScore(level - 1, score);
            loadHighScore();
            
            const finalLevel = level - 1;
            const titleText = finalLevel > 5 
                ? (typeof I18n !== 'undefined' ? I18n.t('patternPuzzle.amazing') : 'üéâ Amazing!')
                : (typeof I18n !== 'undefined' ? I18n.t('patternPuzzle.goodTry') : '‚≠ê Good Try!');
            document.getElementById('gameOverTitle').textContent = titleText;
            
            const reachedLevelText = typeof I18n !== 'undefined' 
                ? I18n.t('patternPuzzle.reachedLevel', { level: finalLevel })
                : `You reached Level ${finalLevel}`;
            document.getElementById('reachedLevelText').textContent = reachedLevelText;
            
            const scoreText = typeof I18n !== 'undefined' 
                ? I18n.t('patternPuzzle.scoreValue', { score: score })
                : `Score: ${score}`;
            document.getElementById('scoreText').textContent = scoreText;
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                const newRecordText = typeof I18n !== 'undefined' ? I18n.t('game.newRecord') : 'üèÜ NEW HIGH SCORE!';
                highMsg.innerHTML = `<span class="new-high">${newRecordText}</span>`;
            } else {
                const practiceText = typeof I18n !== 'undefined' ? I18n.t('result.keepPracticing', { name: playerName }) : 'Keep practicing, ' + playerName + '!';
                highMsg.textContent = practiceText;
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        function startGame() {
            pattern = [];
            playerPattern = [];
            level = 1;
            score = 0;
            isPlaying = true;
            
            document.getElementById('level').textContent = '1';
            document.getElementById('score').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('patternIndicator').innerHTML = '';
            
            addToPattern();
            showPattern();
        }
        
        // Event listeners
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => handleColorClick(btn.dataset.color));
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleColorClick(btn.dataset.color);
            });
        });
        
        document.getElementById('hintsToggle').addEventListener('change', updatePatternIndicator);
        
        // Initialize
        loadHighScore();
        
        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
