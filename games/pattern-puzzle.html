<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Puzzle üîÆ</title>
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        h1 { white-space: nowrap; }
        
        .game-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            background: transparent;
        }
        
        .color-btn {
            width: 130px;
            height: 130px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 4px solid rgba(255,255,255,0.2);
            opacity: 0.7;
        }
        
        .color-btn:hover {
            opacity: 0.9;
        }
        
        .color-btn.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 30px currentColor;
        }
        
        .color-btn.red {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            color: #ff6b6b;
        }
        
        .color-btn.blue {
            background: linear-gradient(145deg, #4ecdc4, #45b7aa);
            color: #4ecdc4;
        }
        
        .color-btn.yellow {
            background: linear-gradient(145deg, #ffe66d, #ffd93d);
            color: #ffe66d;
        }
        
        .color-btn.green {
            background: linear-gradient(145deg, #6bcb77, #5cb868);
            color: #6bcb77;
        }
        
        .message {
            font-size: 22px;
            margin-bottom: 20px;
            min-height: 35px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .start-btn {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233,69,96,0.4);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(233,69,96,0.6);
        }
        
        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.2);
            border-radius: 10px;
            font-size: 14px;
        }
        
        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 100;
        }
        
        #gameOver h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        #gameOver p {
            margin: 10px 0;
            font-size: 18px;
        }
        
        #gameOver button {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233,69,96,0.4);
        }
        
        #gameOver button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(233,69,96,0.6);
        }
        
        .new-high {
            color: #ffd700;
            font-weight: bold;
            animation: glow 1s infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 5px #ffd700; }
            to { text-shadow: 0 0 20px #ffd700; }
        }
        
        .pattern-indicator {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            min-height: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .pattern-indicator.hidden {
            visibility: hidden;
        }
        
        .hints-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .hints-toggle input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .hints-toggle label {
            cursor: pointer;
        }
        
        .pattern-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            opacity: 0.5;
        }
        
        .pattern-dot.current {
            opacity: 1;
            box-shadow: 0 0 10px currentColor;
        }
        
        .pattern-dot.done {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../index.html" class="home-btn">‚Üê Home</a>
        <h1>üîÆ Pattern Puzzle</h1>
    </div>
    
    <div class="stats">
        <div>Level: <span id="level">1</span></div>
        <div>Score: <span id="score">0</span></div>
    </div>
    
    <div class="hints-toggle">
        <input type="checkbox" id="hintsToggle" checked>
        <label for="hintsToggle">Show hints</label>
    </div>
    
    <div class="pattern-indicator" id="patternIndicator"></div>
    
    <div class="game-area">
        <div class="color-btn red" data-color="red"></div>
        <div class="color-btn blue" data-color="blue"></div>
        <div class="color-btn yellow" data-color="yellow"></div>
        <div class="color-btn green" data-color="green"></div>
    </div>
    
    <div class="message" id="message">Watch the pattern!</div>
    
    <button class="start-btn" id="startBtn" style="display: none;">Start Game</button>
    
    <div class="high-score" id="highScoreDisplay">Best Level: --</div>
    
    <div id="gameOver">
        <h2 id="gameOverTitle">Game Over!</h2>
        <p>You reached Level <span id="finalLevel">0</span></p>
        <p>Score: <span id="finalScore">0</span></p>
        <p id="highScoreMsg"></p>
        <button onclick="startGame()">Try Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const colors = ['red', 'blue', 'yellow', 'green'];
        let pattern = [];
        let playerPattern = [];
        let level = 1;
        let score = 0;
        let isPlaying = false;
        let isShowingPattern = false;
        
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        // Get flash duration based on grade (slower for younger kids)
        function getFlashDuration() {
            if (gradeLevel === 'kg') {
                return Math.max(400, 700 - level * 15);
            } else if (gradeLevel === 'g1-3') {
                return Math.max(300, 500 - level * 20);
            }
            return Math.max(200, 400 - level * 25);
        }
        
        function loadHighScore() {
            const highScoreData = localStorage.getItem('patternPuzzle_highScore');
            if (highScoreData) {
                const data = JSON.parse(highScoreData);
                document.getElementById('highScoreDisplay').innerHTML = 
                    `üèÜ Best: Level ${data.level} by ${data.name}`;
            } else {
                document.getElementById('highScoreDisplay').innerHTML = 'Best Level: --';
            }
        }
        
        function saveHighScore(levelReached, scoreValue) {
            const saved = localStorage.getItem('patternPuzzle_highScore');
            const current = saved ? JSON.parse(saved) : null;
            
            if (!current || levelReached > current.level) {
                localStorage.setItem('patternPuzzle_highScore', JSON.stringify({
                    level: levelReached,
                    score: scoreValue,
                    name: playerName
                }));
                return true;
            }
            return false;
        }
        
        function flashButton(color, duration = 400) {
            return new Promise(resolve => {
                const btn = document.querySelector(`.color-btn.${color}`);
                btn.classList.add('active');
                GameUtils.playSound('click');
                setTimeout(() => {
                    btn.classList.remove('active');
                    setTimeout(resolve, 100);
                }, duration);
            });
        }
        
        function updatePatternIndicator() {
            const indicator = document.getElementById('patternIndicator');
            const hintsEnabled = document.getElementById('hintsToggle').checked;
            
            indicator.classList.toggle('hidden', !hintsEnabled);
            indicator.innerHTML = '';
            
            pattern.forEach((color, index) => {
                const dot = document.createElement('div');
                dot.className = `pattern-dot`;
                dot.style.backgroundColor = getColorValue(color);
                dot.style.color = getColorValue(color);
                
                if (index < playerPattern.length) {
                    dot.classList.add('done');
                } else if (index === playerPattern.length) {
                    dot.classList.add('current');
                }
                
                indicator.appendChild(dot);
            });
        }
        
        function getColorValue(color) {
            const values = {
                red: '#ff6b6b',
                blue: '#4ecdc4',
                yellow: '#ffe66d',
                green: '#6bcb77'
            };
            return values[color];
        }
        
        async function showPattern() {
            isShowingPattern = true;
            document.getElementById('message').textContent = 'Watch carefully...';
            
            updatePatternIndicator();
            
            await new Promise(r => setTimeout(r, 500));
            
            for (const color of pattern) {
                await flashButton(color, getFlashDuration());
            }
            
            isShowingPattern = false;
            document.getElementById('message').textContent = 'Your turn! Repeat the pattern';
            playerPattern = [];
            updatePatternIndicator();
        }
        
        function addToPattern() {
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            pattern.push(randomColor);
        }
        
        async function handleColorClick(color) {
            if (!isPlaying || isShowingPattern) return;
            
            await flashButton(color, 200);
            playerPattern.push(color);
            updatePatternIndicator();
            
            // Check if correct
            const currentIndex = playerPattern.length - 1;
            
            if (playerPattern[currentIndex] !== pattern[currentIndex]) {
                // Wrong!
                GameUtils.playSound('wrong');
                gameOver();
                return;
            }
            
            // Check if pattern complete
            if (playerPattern.length === pattern.length) {
                GameUtils.playSound('correct');
                score += level * 10;
                document.getElementById('score').textContent = score;
                
                level++;
                document.getElementById('level').textContent = level;
                document.getElementById('message').textContent = '‚ú® Perfect! Next level...';
                
                if (level % 3 === 0) {
                    GameUtils.playSound('levelUp');
                }
                
                addToPattern();
                
                setTimeout(() => {
                    playerPattern = [];
                    showPattern();
                }, 1000);
            }
        }
        
        function gameOver() {
            isPlaying = false;
            
            const isNewHigh = saveHighScore(level - 1, score);
            loadHighScore();
            
            document.getElementById('gameOverTitle').textContent = level > 5 ? 'üéâ Great Job!' : 'üòÖ Game Over!';
            document.getElementById('finalLevel').textContent = level - 1;
            document.getElementById('finalScore').textContent = score;
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                highMsg.innerHTML = '<span class="new-high">üèÜ NEW HIGH SCORE!</span>';
            } else {
                highMsg.textContent = 'Keep practicing, ' + playerName + '!';
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        function startGame() {
            pattern = [];
            playerPattern = [];
            level = 1;
            score = 0;
            isPlaying = true;
            
            document.getElementById('level').textContent = '1';
            document.getElementById('score').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('patternIndicator').innerHTML = '';
            
            addToPattern();
            showPattern();
        }
        
        // Event listeners
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => handleColorClick(btn.dataset.color));
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleColorClick(btn.dataset.color);
            });
        });
        
        document.getElementById('hintsToggle').addEventListener('change', updatePatternIndicator);
        
        // Initialize
        loadHighScore();
        
        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
</body>
</html>
