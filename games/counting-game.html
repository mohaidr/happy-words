<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script src="../js/analytics.js"></script>
    <script src="../js/i18n.js"></script>
    <title>Counting Game üî¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <style>
        /* Game-specific styles */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        h1 { white-space: nowrap; }
        
        .question {
            font-size: 22px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .objects-container {
            width: 320px;
            min-height: 120px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            align-content: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            box-sizing: border-box;
        }
        
        .object {
            font-size: 36px;
            animation: bounce 1s ease-in-out infinite;
            line-height: 1;
        }
        
        .object.small {
            font-size: 28px;
        }
        
        .object:nth-child(odd) {
            animation-delay: 0.1s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .answers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .answer-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, #48dbfb, #0abde3);
            border: none;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(72,219,251,0.4);
        }
        
        .answer-btn:hover {
            transform: scale(1.1);
        }
        
        .answer-btn.correct {
            background: linear-gradient(145deg, #00d084, #00a65a);
            animation: correctPulse 0.5s ease;
        }
        
        .answer-btn.wrong {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            animation: shake 0.5s ease;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .message {
            font-size: 24px;
            margin-bottom: 15px;
            min-height: 35px;
            text-align: center;
        }
        
        button.btn {
            background: linear-gradient(145deg, #f093fb, #f5576c);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(240,147,251,0.4);
        }
        
        button.btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(240,147,251,0.6);
        }
        
        .high-score {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,215,0,0.3);
            border-radius: 10px;
            font-size: 14px;
        }
        
        .streak {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="../home.html" class="home-btn" data-i18n="game.home">‚Üê Home</a>
        <a href="category-math.html" class="category-btn" data-i18n="nav.math">üî¢ Math</a>
        <h1 data-i18n="countingGame.title">üî¢ Counting Game</h1>
    </div>
    
    <div class="stats">
        <div><span data-i18n="game.score">Score</span>: <span id="score">0</span></div>
        <div><span data-i18n="game.round">Round</span>: <span id="round">1</span>/10</div>
        <div class="streak">üî• <span id="streak">0</span></div>
    </div>
    
    <div class="question" id="question" data-i18n="countingGame.question">How many do you see?</div>
    
    <div class="objects-container" id="objectsContainer"></div>
    
    <div class="answers" id="answers"></div>
    
    <div class="message" id="message"></div>
    
    <div class="high-score" id="highScoreDisplay"><span data-i18n="game.best">Best</span>: -- <span data-i18n="game.points">points</span></div>
    
    <div id="gameOver">
        <h2 data-i18n="countingGame.result">üéâ Great Counting!</h2>
        <p><span data-i18n="game.score">Score</span>: <span id="finalScore">0</span></p>
        <p><span data-i18n="countingGame.bestStreak">Best Streak</span>: <span id="bestStreak">0</span> üî•</p>
        <p id="highScoreMsg"></p>
        <button class="btn" onclick="startGame()" data-i18n="game.playAgain">Play Again</button>
    </div>

    <script src="../js/game-utils.js"></script>
    <script>
        const emojis = ['üçé', '‚≠ê', 'üå∏', 'üê∂', 'üéà', 'ü¶ã', 'üçï', 'üöó', 'üåü', 'üéÅ', 'üê±', 'üç¶', 'üåª', 'üê∏', '‚öΩ'];
        
        let score = 0;
        let round = 0;
        let streak = 0;
        let bestStreak = 0;
        let totalRounds = 10;
        let currentCount = 0;
        let gameRunning = false;
        let canClick = true;
        let usedCounts = [];
        
        const playerName = GameUtils.getPlayerName();
        const gradeLevel = GameUtils.getGradeLevel();
        
        // High score system
        const GAME_KEY = 'countingGame';
        
        function loadHighScore() {
            const saved = GameUtils.getHighScore(GAME_KEY);
            if (saved > 0) {
                const bestPlayer = GameUtils.getHighScorePlayerName(GAME_KEY);
                const highScoreText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.highScorePoints', { score: saved, player: bestPlayer })
                    : `üèÜ Best: ${saved} points by ${bestPlayer}`;
                document.getElementById('highScoreDisplay').innerHTML = highScoreText;
            } else {
                const defaultText = typeof I18n !== 'undefined' 
                    ? I18n.t('game.defaultHighScore')
                    : 'Best: -- points';
                document.getElementById('highScoreDisplay').innerHTML = defaultText;
            }
        }
        
        function getMaxCount() {
            if (gradeLevel === 'kg') return 5;
            if (gradeLevel === 'g1-3') return 10;
            return 15;
        }
        
        function loadRound() {
            round++;
            document.getElementById('round').textContent = round;
            canClick = true;
            
            // Pick random emoji
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            // Generate available counts (1-10) that haven't been used
            const availableCounts = [];
            for (let i = 1; i <= 10; i++) {
                if (!usedCounts.includes(i)) {
                    availableCounts.push(i);
                }
            }
            
            // Pick a random count from available ones
            currentCount = availableCounts[Math.floor(Math.random() * availableCounts.length)];
            usedCounts.push(currentCount);
            
            // Display objects
            const container = document.getElementById('objectsContainer');
            container.innerHTML = '';
            
            // Use smaller size for many objects
            const useSmall = currentCount > 8;
            
            for (let i = 0; i < currentCount; i++) {
                const obj = document.createElement('span');
                obj.className = 'object' + (useSmall ? ' small' : '');
                obj.textContent = emoji;
                obj.style.animationDelay = (i * 0.1) + 's';
                container.appendChild(obj);
            }
            
            // Update question
            const questionKey = 'countingGame.howMany';
            const questionText = typeof I18n !== 'undefined' && I18n.translations[questionKey] 
                ? I18n.t(questionKey, { emoji: emoji })
                : `How many ${emoji} do you see?`;
            document.getElementById('question').textContent = questionText;
            
            // Generate answer options
            const answers = [currentCount];
            const numOptions = gradeLevel === 'kg' ? 3 : 4;
            
            while (answers.length < numOptions) {
                let wrong = currentCount + Math.floor(Math.random() * 5) - 2;
                if (wrong < 1) wrong = currentCount + Math.floor(Math.random() * 3) + 1;
                if (wrong !== currentCount && !answers.includes(wrong) && wrong > 0) {
                    answers.push(wrong);
                }
            }
            
            // Shuffle answers
            answers.sort(() => Math.random() - 0.5);
            
            // Create answer buttons
            const answersEl = document.getElementById('answers');
            answersEl.innerHTML = '';
            answersEl.style.gridTemplateColumns = `repeat(${numOptions}, 1fr)`;
            
            answers.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = num;
                btn.onclick = () => checkAnswer(num, btn);
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    checkAnswer(num, btn);
                });
                answersEl.appendChild(btn);
            });
            
            document.getElementById('message').textContent = '';
        }
        
        function checkAnswer(num, btn) {
            if (!gameRunning || !canClick) return;
            canClick = false;
            
            if (num === currentCount) {
                // Correct!
                streak++;
                if (streak > bestStreak) bestStreak = streak;
                document.getElementById('streak').textContent = streak;
                
                const bonus = streak > 2 ? streak * 5 : 0;
                score += 10 + bonus;
                document.getElementById('score').textContent = score;
                
                // Use localized messages
                let correctMsg;
                if (streak > 2) {
                    correctMsg = typeof I18n !== 'undefined' 
                        ? I18n.t('countingGame.correctBonus', { bonus: bonus })
                        : `‚ú® Correct! +${bonus} streak bonus!`;
                } else {
                    correctMsg = typeof I18n !== 'undefined' 
                        ? I18n.t('countingGame.correct')
                        : '‚ú® Correct!';
                }
                document.getElementById('message').textContent = correctMsg;
                
                btn.classList.add('correct');
                GameUtils.playSound('correct');
                
                setTimeout(() => {
                    btn.classList.remove('correct');
                    if (round < totalRounds) {
                        loadRound();
                    } else {
                        endGame();
                    }
                }, 800);
            } else {
                // Wrong
                streak = 0;
                document.getElementById('streak').textContent = '0';
                
                // Use localized message
                const wrongMsg = typeof I18n !== 'undefined' 
                    ? I18n.t('countingGame.itWas', { count: currentCount })
                    : `‚ùå It was ${currentCount}!`;
                document.getElementById('message').textContent = wrongMsg;
                
                btn.classList.add('wrong');
                GameUtils.playSound('wrong');
                
                // Show correct answer
                document.querySelectorAll('.answer-btn').forEach(b => {
                    if (parseInt(b.textContent) === currentCount) {
                        b.classList.add('correct');
                    }
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.answer-btn').forEach(b => {
                        b.classList.remove('wrong', 'correct');
                    });
                    if (round < totalRounds) {
                        loadRound();
                    } else {
                        endGame();
                    }
                }, 1200);
            }
        }
        
        function startGame() {
            score = 0;
            round = 0;
            streak = 0;
            bestStreak = 0;
            usedCounts = [];
            gameRunning = true;
            
            document.getElementById('score').textContent = '0';
            document.getElementById('streak').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';
            
            loadRound();
        }
        
        function endGame() {
            gameRunning = false;
            
            const isNewHigh = GameUtils.saveHighScore(GAME_KEY, score, playerName);
            loadHighScore();
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('bestStreak').textContent = bestStreak;
            
            const highMsg = document.getElementById('highScoreMsg');
            if (isNewHigh) {
                const newRecordText = typeof I18n !== 'undefined' ? I18n.t('game.newRecord') : 'üèÜ NEW HIGH SCORE!';
                highMsg.innerHTML = `<span class="new-high">${newRecordText}</span>`;
            } else {
                const goodJobText = typeof I18n !== 'undefined' ? I18n.t('result.goodJob', { name: playerName }) : 'Great counting, ' + playerName + '!';
                highMsg.textContent = goodJobText;
            }
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Initialize
        loadHighScore();
        
        // Initialize sound toggle
        GameUtils.initSoundToggle();
        
        // Auto-start game on load
        setTimeout(() => startGame(), 500);
    </script>
    <script>
        // Add language toggle button
        if (typeof I18n !== 'undefined') {
            const langBtn = I18n.createLanguageToggle();
            document.body.appendChild(langBtn);
        }
    </script>
</body>
</html>
